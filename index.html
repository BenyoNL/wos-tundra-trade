<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Whiteout Survival - Tundra Trade</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; margin: 0; padding: 20px; background-color: #f4f7f6; }
        .container { background: white; max-width: 800px; margin: auto; padding: 20px; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        input, select { width: 90%; padding: 10px; margin: 10px 0; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; font-size: 16px;}
        .btn { padding: 10px 20px; margin: 5px 0; font-size: 16px; cursor: pointer; color: white; border: none; border-radius: 5px; font-weight: bold; width: 90%; }
        .btn-blue { background-color: #4285F4; } .btn-blue:hover { background-color: #357ae8; }
        .btn-green { background-color: #28a745; } .btn-green:hover { background-color: #218838; }
        .btn-dark { background-color: #333; } .btn-dark:hover { background-color: #555; }
        .btn-red { background-color: #d9534f; } .btn-red:hover { background-color: #c9302c; }
        .btn-back { background-color: #8892a3; width: auto; padding: 8px 15px; margin-bottom: 15px; }
        .btn-small { padding: 5px 10px; font-size: 12px; margin-left: 10px; width: auto; }
        
        .list-item { background: #1a2a40; color: white; padding: 15px; border-radius: 8px; margin: 10px auto; cursor: pointer; font-size: 18px; font-weight: bold; width: 90%; transition: transform 0.1s; text-align: center;}
        .list-item:active { transform: scale(0.98); }
        .card-item { background: #e09f3e; color: white; }
        .search-item { background: #17a2b8; color: white; text-align: left; padding: 10px 15px; }
        .search-item span { display: block; font-size: 12px; color: #eef2f5; font-weight: normal; }

        #top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; background: #fff; padding: 10px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);}
        #lang-selector { width: auto; padding: 5px; margin: 0; font-size: 14px;}
        
        .action-buttons { display: flex; justify-content: center; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;}
        #search-bar { position: sticky; top: 0; background: white; padding: 10px 0; z-index: 10; border-bottom: 2px solid #eee; margin-bottom: 15px;}
        
        .puzzle-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(110px, 1fr)); gap: 10px; margin-top: 10px; }
        
        /* Keyboard focus style for puzzle pieces */
        .puzzle-piece { border-radius: 8px; padding: 5px; background: #5a82e6; display: flex; flex-direction: column; align-items: center; justify-content: space-between; min-height: 100px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); outline: none; transition: transform 0.1s;}
        .puzzle-piece:focus { border: 3px solid #ffc107; transform: scale(1.05); }
        
        .piece-shape { width: 40px; height: 40px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 16px; margin-bottom: 5px;}
        
        .controls { display: flex; align-items: center; justify-content: space-between; width: 100%; background: white; border-radius: 5px; overflow: hidden; }
        .qty-btn { background: #ddd; border: none; padding: 5px 10px; cursor: pointer; font-weight: bold; font-size: 14px; }
        .qty-btn.plus { background: #6bc85f; color: white; }
        .qty-btn.minus { background: #d9534f; color: white; }
        .qty-display { font-weight: bold; color: #333; font-size: 16px;}
        .piece-missing { background: #8892a3; }
        .piece-surplus { background: #28a745; } /* Z√∂ldebb, ha van felesleg */
        
        #toast-msg {
            visibility: hidden; min-width: 250px; background-color: rgba(40, 167, 69, 0.95);
            color: #fff; text-align: center; border-radius: 8px; padding: 15px;
            position: fixed; z-index: 1000; left: 50%; top: 50%; transform: translate(-50%, -50%);
            font-size: 18px; font-weight: bold; box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            opacity: 0; transition: opacity 0.3s, visibility 0.3s; pointer-events: none;
        }
        #toast-msg.show { visibility: visible; opacity: 1; }
        
        .match-card { background: #2a3b50; color: white; padding: 15px; border-radius: 8px; margin: 10px auto; width: 90%; text-align: left; box-shadow: 0 2px 5px rgba(0,0,0,0.2);}
        .match-card h4 { margin: 0 0 10px 0; color: #ffd700; border-bottom: 1px solid #4a5b70; padding-bottom: 5px;}
        .match-detail { margin: 5px 0; font-size: 14px; background: rgba(0,0,0,0.2); padding: 8px; border-radius: 5px;}
        .trade-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; border-bottom: 1px dashed rgba(255,255,255,0.1); padding-bottom: 5px;}
    </style>
</head>
<body>

    <div id="toast-msg">‚úÖ Saved!</div>

    <div id="auth-screen" class="container">
        <h2>Login or Register</h2>
        <input type="email" id="email-input" placeholder="Email address">
        <input type="password" id="password-input" placeholder="Password">
        <div id="auth-error" style="color:red; margin-bottom:10px;"></div>
        <button id="email-login-btn" class="btn btn-green">Login with Email</button>
        <button id="email-register-btn" class="btn btn-dark">Register new account</button>
        <hr><button id="google-login-btn" class="btn btn-blue">Login with Google</button>
    </div>

    <div id="profile-setup-screen" class="container" style="display: none;">
        <h2>Setup your profile</h2>
        <input type="text" id="player-name" placeholder="Player Name (any characters)">
        <input type="number" id="server-number" placeholder="State/Server (exactly 4 digits, e.g., 2530)">
        <input type="text" id="alliance-name" placeholder="Alliance Tag (exactly 3 chars, e.g., ABC)">
        <div id="profile-error" style="color:red; margin-bottom:10px;"></div>
        <button id="save-profile-btn" class="btn btn-green">Save & Continue</button>
    </div>

    <div id="main-app-screen" class="container" style="display: none;">
        
        <div id="top-bar">
            <div style="text-align: left;">
                <h3 style="margin: 0; color:#4285F4;" id="display-name"></h3>
                <small><span class="t-state">State</span>: <b id="display-server"></b> | <span class="t-alliance">Alliance</span>: <b id="display-alliance"></b></small>
            </div>
            <div>
                <select id="lang-selector" onchange="changeLanguage(this.value)">
                    <option value="en" selected>üá¨üáß English</option>
                    <option value="hu">üá≠üá∫ Magyar</option>
                    <option value="de">üá©üá™ Deutsch</option>
                    <option value="fr">üá´üá∑ Fran√ßais</option>
                    <option value="tr">üáπüá∑ T√ºrk√ße</option>
                    <option value="ru">üá∑üá∫ –†—É—Å—Å–∫–∏–π</option>
                    <option value="ar">üá∏üá¶ ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
                </select>
            </div>
        </div>
        
        <div class="action-buttons">
            <button onclick="runMatchmaker('alliance')" class="btn btn-dark t-btn-clan" style="width: 48%;">ü§ù Search in Clan</button>
            <button onclick="runMatchmaker('state')" class="btn btn-dark t-btn-state" style="width: 48%;">üåç Search in State</button>
        </div>

        <div id="search-bar">
            <input type="text" id="search-input" class="t-search-ph" placeholder="üîç Search album or card...">
        </div>

        <div id="view-albums"></div>
        <div id="view-cards" style="display: none;"></div>
        <div id="view-puzzle" style="display: none;"></div>
        <div id="view-search-results" style="display: none;"></div>
        <div id="view-matchmaker" style="display: none;"></div>

        <br><hr><br>
        <button id="save-inventory-btn" class="btn btn-green t-btn-save" style="font-size: 18px; padding: 15px;">üíæ Save Changes</button>
        <br><br>
        <button id="logout-btn" class="btn btn-red t-btn-logout" style="width: auto;">Logout</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, query, where, getDocs, increment } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

        // M√ÅSOLD BE A SAJ√ÅT KULCSODAT!
        const firebaseConfig = {
  apiKey: "AIzaSyDeEK5nOuvuELtGd61Q7W04uKGcJqG1L1U",
  authDomain: "tundra-album.firebaseapp.com",
  projectId: "tundra-album",
  storageBucket: "tundra-album.firebasestorage.app",
  messagingSenderId: "469371801375",
  appId: "1:469371801375:web:71007b232a98fe8bdbea2a",
  measurementId: "G-2LQT9X23X5"
};

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        let currentUserUid = null;
        let userInventory = {}; 
        let currentAlbumGlobal = null;
        let currentCardGlobal = null;

        // --- DICTIONARY (Ford√≠t√°sok) ---
        const i18n = {
            en: { state: "State", alliance: "Alliance", btnClan: "ü§ù Search in Clan", btnState: "üåç Search in State", searchPh: "üîç Search album or card...", btnSave: "üíæ Save Changes", btnLogout: "Logout", backAlbum: "‚¨Ö Back to Albums", backCard: "‚¨Ö Back to Cards", markDone: "‚úî Set all missing to 1", noMatch: "No matching players found.", givesYou: "They can give you:", asksFrom: "They ask from you:", traded: "Traded!" },
            hu: { state: "√Ållam", alliance: "Sz√∂vets√©g", btnClan: "ü§ù Keres√©s Kl√°nban", btnState: "üåç Keres√©s √Ållamban", searchPh: "üîç Keres√©s albumra vagy k√°rty√°ra...", btnSave: "üíæ V√°ltoz√°sok Ment√©se", btnLogout: "Kijelentkez√©s", backAlbum: "‚¨Ö Vissza az Albumokhoz", backCard: "‚¨Ö Vissza a K√°rty√°khoz", markDone: "‚úî Hi√°nyz√≥k 1-re √°ll√≠t√°sa", noMatch: "Nincs tal√°lat a cserepartnerekre.", givesYou: "Tud adni neked:", asksFrom: "K√©ri t≈ëled:", traded: "Elcser√©lt√ºk!" },
            de: { state: "Staat", alliance: "Allianz", btnClan: "ü§ù Suche im Clan", btnState: "üåç Suche im Staat", searchPh: "üîç Album oder Karte suchen...", btnSave: "üíæ √Ñnderungen speichern", btnLogout: "Abmelden", backAlbum: "‚¨Ö Zur√ºck zu Alben", backCard: "‚¨Ö Zur√ºck zu Karten", markDone: "‚úî Alle fehlenden auf 1", noMatch: "Keine passenden Spieler gefunden.", givesYou: "Kann dir geben:", asksFrom: "Fragt von dir:", traded: "Gehandelt!" },
            fr: { state: "√âtat", alliance: "Alliance", btnClan: "ü§ù Chercher dans le Clan", btnState: "üåç Chercher dans l'√âtat", searchPh: "üîç Chercher un album ou une carte...", btnSave: "üíæ Sauvegarder", btnLogout: "D√©connexion", backAlbum: "‚¨Ö Retour aux Albums", backCard: "‚¨Ö Retour aux Cartes", markDone: "‚úî Marquer manquants √† 1", noMatch: "Aucun joueur correspondant trouv√©.", givesYou: "Peut vous donner:", asksFrom: "Vous demande:", traded: "√âchang√©!" },
            tr: { state: "Eyalet", alliance: "ƒ∞ttifak", btnClan: "ü§ù Klanda Ara", btnState: "üåç Eyalette Ara", searchPh: "üîç Alb√ºm veya kart ara...", btnSave: "üíæ Deƒüi≈üiklikleri Kaydet", btnLogout: "√áƒ±kƒ±≈ü Yap", backAlbum: "‚¨Ö Alb√ºmlere D√∂n", backCard: "‚¨Ö Kartlara D√∂n", markDone: "‚úî Eksikleri 1 yap", noMatch: "E≈üle≈üen oyuncu bulunamadƒ±.", givesYou: "Sana verebilir:", asksFrom: "Senden istiyor:", traded: "Takas edildi!" },
            ru: { state: "–®—Ç–∞—Ç", alliance: "–ê–ª—å—è–Ω—Å", btnClan: "ü§ù –ü–æ–∏—Å–∫ –≤ –∫–ª–∞–Ω–µ", btnState: "üåç –ü–æ–∏—Å–∫ –≤ —à—Ç–∞—Ç–µ", searchPh: "üîç –ü–æ–∏—Å–∫ –∞–ª—å–±–æ–º–∞ –∏–ª–∏ –∫–∞—Ä—Ç—ã...", btnSave: "üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è", btnLogout: "–í—ã–π—Ç–∏", backAlbum: "‚¨Ö –ù–∞–∑–∞–¥ –∫ –∞–ª—å–±–æ–º–∞–º", backCard: "‚¨Ö –ù–∞–∑–∞–¥ –∫ –∫–∞—Ä—Ç–∞–º", markDone: "‚úî –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –Ω–∞ 1", noMatch: "–ü–æ–¥—Ö–æ–¥—è—â–∏—Ö –∏–≥—Ä–æ–∫–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.", givesYou: "–ú–æ–∂–µ—Ç –¥–∞—Ç—å –≤–∞–º:", asksFrom: "–ü—Ä–æ—Å–∏—Ç —É –≤–∞—Å:", traded: "–û–±–º–µ–Ω—è–ª–∏—Å—å!" },
            ar: { state: "ÿ≠ÿßŸÑÿ©", alliance: "ÿ™ÿ≠ÿßŸÑŸÅ", btnClan: "ü§ù ÿßŸÑÿ®ÿ≠ÿ´ ŸÅŸä ÿßŸÑÿπÿ¥Ÿäÿ±ÿ©", btnState: "üåç ÿßŸÑÿ®ÿ≠ÿ´ ŸÅŸä ÿßŸÑŸàŸÑÿßŸäÿ©", searchPh: "üîç ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿ£ŸÑÿ®ŸàŸÖ ÿ£Ÿà ÿ®ÿ∑ÿßŸÇÿ©...", btnSave: "üíæ ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿ∫ŸäŸäÿ±ÿßÿ™", btnLogout: "ÿ™ÿ≥ÿ¨ŸäŸÑ ÿÆÿ±Ÿàÿ¨", backAlbum: "‚¨Ö ÿßŸÑÿπŸàÿØÿ© ŸÑŸÑÿ£ŸÑÿ®ŸàŸÖÿßÿ™", backCard: "‚¨Ö ÿßŸÑÿπŸàÿØÿ© ŸÑŸÑÿ®ÿ∑ÿßŸÇÿßÿ™", markDone: "‚úî ÿ™ÿπŸäŸäŸÜ ÿßŸÑŸÖŸÅŸÇŸàÿØ ÿ•ŸÑŸâ 1", noMatch: "ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ŸÑÿßÿπÿ®ŸäŸÜ.", givesYou: "ŸäŸÖŸÉŸÜ ÿ£ŸÜ Ÿäÿπÿ∑ŸäŸÉ:", asksFrom: "Ÿäÿ∑ŸÑÿ® ŸÖŸÜŸÉ:", traded: "ÿ™ŸÖ ÿßŸÑÿ™ÿ®ÿßÿØŸÑ!" }
        };
        let currLang = 'en';

        window.changeLanguage = function(lang) {
            currLang = lang;
            document.querySelector('.t-state').textContent = i18n[lang].state;
            document.querySelector('.t-alliance').textContent = i18n[lang].alliance;
            document.querySelector('.t-btn-clan').textContent = i18n[lang].btnClan;
            document.querySelector('.t-btn-state').textContent = i18n[lang].btnState;
            document.querySelector('.t-search-ph').placeholder = i18n[lang].searchPh;
            document.querySelector('.t-btn-save').textContent = i18n[lang].btnSave;
            document.querySelector('.t-btn-logout').textContent = i18n[lang].btnLogout;
            
            // Re-render current view to update buttons
            if(document.getElementById('view-cards').style.display === 'block') renderCards(currentAlbumGlobal);
            if(document.getElementById('view-puzzle').style.display === 'block') renderPuzzle(currentAlbumGlobal, currentCardGlobal);
        };

        // Adatb√°zis gener√°l√°s
        const albumNames = [ "Rekindled Flames", "Explore the World", "Daybreak Island", "Tundra Alliance", "Battlefield Epic", "Spectacular Adventures", "Divine Weapons", "Song of Heroes", "The Labyrinth", "Nature‚Äôs Strength", "Crystalline Mysteries", "Ballad of Wind and Cold", "Infernal Power", "Prerogative of the Flame", "Frostdragon Empire", "Kings of Combat" ];
        const gameData = albumNames.map((name, aIdx) => {
            return {
                id: `album_${aIdx}`, name: name,
                cards: Array.from({length: 9}, (_, cIdx) => ({ id: `album_${aIdx}_card_${cIdx+1}`, name: `Card ${cIdx+1}` }))
            };
        });

        // K√©perny≈ëk kezel√©se
        const authScreen = document.getElementById('auth-screen');
        const profileScreen = document.getElementById('profile-setup-screen');
        const mainScreen = document.getElementById('main-app-screen');

        function showScreen(screen) {
            authScreen.style.display = 'none'; profileScreen.style.display = 'none'; mainScreen.style.display = 'none';
            screen.style.display = 'block';
        }

        document.getElementById('email-register-btn').addEventListener('click', () => createUserWithEmailAndPassword(auth, document.getElementById('email-input').value, document.getElementById('password-input').value).catch(e => document.getElementById('auth-error').textContent = e.message));
        document.getElementById('email-login-btn').addEventListener('click', () => signInWithEmailAndPassword(auth, document.getElementById('email-input').value, document.getElementById('password-input').value).catch(e => document.getElementById('auth-error').textContent = "Incorrect data."));
        document.getElementById('google-login-btn').addEventListener('click', () => signInWithPopup(auth, provider).catch(e => console.error(e)));
        document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));

        // --- VALID√ÅCI√ì (Profil ment√©s) ---
        document.getElementById('save-profile-btn').addEventListener('click', async () => {
            const pName = document.getElementById('player-name').value.trim();
            const pServer = document.getElementById('server-number').value.trim();
            const pAlliance = document.getElementById('alliance-name').value.trim().toUpperCase();
            const errorDiv = document.getElementById('profile-error');

            if(!pName || !pServer || !pAlliance) { errorDiv.textContent = "Please fill all fields!"; return; }
            if(pServer.length !== 4 || isNaN(pServer)) { errorDiv.textContent = "State must be exactly 4 numbers (e.g., 2530)."; return; }
            if(pAlliance.length !== 3) { errorDiv.textContent = "Alliance tag must be exactly 3 characters (e.g., ABC)."; return; }

            await setDoc(doc(db, "jatekosok", currentUserUid), { jatekNev: pName, szerver: pServer, szovetseg: pAlliance, inventory: {} });
            checkUserProfile(currentUserUid);
        });

        async function checkUserProfile(uid) {
            const docSnap = await getDoc(doc(db, "jatekosok", uid));
            if (docSnap.exists() && docSnap.data().szerver) {
                const data = docSnap.data();
                document.getElementById('display-name').textContent = data.jatekNev || data.nev;
                document.getElementById('display-server').textContent = data.szerver;
                document.getElementById('display-alliance').textContent = data.szovetseg;
                userInventory = data.inventory || {}; 
                renderAlbums(); 
                showScreen(mainScreen);
            } else {
                showScreen(profileScreen);
            }
        }

        onAuthStateChanged(auth, (user) => {
            if (user) { currentUserUid = user.uid; checkUserProfile(user.uid); } 
            else { currentUserUid = null; showScreen(authScreen); }
        });

        const viewAlbums = document.getElementById('view-albums');
        const viewCards = document.getElementById('view-cards');
        const viewPuzzle = document.getElementById('view-puzzle');
        const viewSearch = document.getElementById('view-search-results');
        const viewMatchmaker = document.getElementById('view-matchmaker');
        const searchInput = document.getElementById('search-input');

        function hideAllViews() {
            viewAlbums.style.display = 'none'; viewCards.style.display = 'none';
            viewPuzzle.style.display = 'none'; viewSearch.style.display = 'none';
            viewMatchmaker.style.display = 'none';
        }

        function renderAlbums() {
            hideAllViews();
            currentAlbumGlobal = null; currentCardGlobal = null;
            searchInput.value = ''; 
            viewAlbums.innerHTML = '';
            gameData.forEach(album => {
                const btn = document.createElement('div');
                btn.className = 'list-item';
                btn.textContent = `üìñ ${album.name}`;
                btn.onclick = () => renderCards(album);
                viewAlbums.appendChild(btn);
            });
            viewAlbums.style.display = 'block';
        }

        function renderCards(album) {
            hideAllViews();
            currentAlbumGlobal = album;
            searchInput.value = '';
            viewCards.innerHTML = '';
            
            const backBtn = document.createElement('button');
            backBtn.className = 'btn btn-back';
            backBtn.textContent = i18n[currLang].backAlbum;
            backBtn.onclick = () => renderAlbums();
            
            viewCards.appendChild(backBtn);
            viewCards.insertAdjacentHTML('beforeend', `<h3>üìñ ${album.name}</h3>`);
            
            album.cards.forEach(card => {
                const btn = document.createElement('div');
                btn.className = 'list-item card-item';
                btn.textContent = card.name;
                btn.onclick = () => renderPuzzle(album, card);
                viewCards.appendChild(btn);
            });
            viewCards.style.display = 'block';
        }

        // --- PUZZLE N√âZET + GYORS√çT√ì GOMB ---
        window.renderPuzzle = function(album, card) {
            hideAllViews();
            currentAlbumGlobal = album; currentCardGlobal = card;
            searchInput.value = '';
            viewPuzzle.innerHTML = '';
            
            const topControls = document.createElement('div');
            topControls.style.display = "flex"; topControls.style.justifyContent = "space-between"; topControls.style.alignItems = "center";
            
            const backBtn = document.createElement('button');
            backBtn.className = 'btn btn-back';
            backBtn.style.margin = "0";
            backBtn.textContent = i18n[currLang].backCard;
            backBtn.onclick = () => renderCards(album);
            
            // GYORS√çT√ì GOMB (Minden null√°sat 1-re √°ll√≠t)
            const markDoneBtn = document.createElement('button');
            markDoneBtn.className = 'btn btn-green';
            markDoneBtn.style.width = "auto"; markDoneBtn.style.padding = "8px 15px"; markDoneBtn.style.margin = "0";
            markDoneBtn.textContent = i18n[currLang].markDone;
            markDoneBtn.onclick = () => {
                for(let p = 1; p <= 15; p++) {
                    const pid = `${card.id}_piece_${p}`;
                    if(!userInventory[pid] || userInventory[pid] === 0) {
                        userInventory[pid] = 1; // Csak a hi√°nyz√≥t m√≥dos√≠tja!
                    }
                }
                renderPuzzle(album, card); // √öjrarajzolja a r√°csot
            };

            topControls.appendChild(backBtn);
            topControls.appendChild(markDoneBtn);
            
            viewPuzzle.appendChild(topControls);
            viewPuzzle.insertAdjacentHTML('beforeend', `<h3><small>${album.name}</small><br>${card.name}</h3>`);
            
            const grid = document.createElement('div');
            grid.className = 'puzzle-grid';

            for(let p = 1; p <= 15; p++) {
                const pieceId = `${card.id}_piece_${p}`;
                const currentQty = userInventory[pieceId] || 0; 
                
                // VIZU√ÅLIS LOGIKA: 0, ‚úî, vagy +X
                let displayQty = currentQty;
                let bgClass = '';
                if (currentQty === 0) { displayQty = "0"; bgClass = 'piece-missing'; }
                else if (currentQty === 1) { displayQty = "‚úî"; }
                else { displayQty = `+${currentQty - 1}`; bgClass = 'piece-surplus'; }
                
                const pieceDiv = document.createElement('div');
                pieceDiv.className = `puzzle-piece ${bgClass}`;
                pieceDiv.id = `box-${pieceId}`;
                pieceDiv.tabIndex = 0; // BILLENTY≈∞ZET F√ìKUSZ
                
                // BILLENTY≈∞ZET NAVIG√ÅCI√ì (Fel, Le, Balra, Jobbra)
                pieceDiv.onkeydown = (e) => {
                    if (e.key === 'ArrowUp') { updateQty(pieceId, 1); e.preventDefault(); }
                    if (e.key === 'ArrowDown') { updateQty(pieceId, -1); e.preventDefault(); }
                    if (e.key === 'ArrowRight') { 
                        if(pieceDiv.nextElementSibling) pieceDiv.nextElementSibling.focus(); 
                        e.preventDefault(); 
                    }
                    if (e.key === 'ArrowLeft') { 
                        if(pieceDiv.previousElementSibling) pieceDiv.previousElementSibling.focus(); 
                        e.preventDefault(); 
                    }
                };
                
                pieceDiv.innerHTML = `
                    <div class="piece-shape">${p}</div>
                    <div class="controls">
                        <button tabindex="-1" class="qty-btn minus" onclick="updateQty('${pieceId}', -1); document.getElementById('box-${pieceId}').focus();">-</button>
                        <span class="qty-display" id="qty-${pieceId}">${displayQty}</span>
                        <button tabindex="-1" class="qty-btn plus" onclick="updateQty('${pieceId}', 1); document.getElementById('box-${pieceId}').focus();">+</button>
                    </div>
                `;
                grid.appendChild(pieceDiv);
            }
            viewPuzzle.appendChild(grid);
            viewPuzzle.style.display = 'block';
        }

        searchInput.addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase().trim();
            if(query === '') return renderAlbums();

            hideAllViews();
            viewSearch.innerHTML = `<h3>... "${query}"</h3>`;
            let foundSomething = false;

            gameData.forEach(album => {
                if(album.name.toLowerCase().includes(query)) {
                    foundSomething = true;
                    const res = document.createElement('div');
                    res.className = 'list-item search-item';
                    res.innerHTML = `üìñ ${album.name}`;
                    res.onclick = () => renderCards(album);
                    viewSearch.appendChild(res);
                }
                album.cards.forEach(card => {
                    if(card.name.toLowerCase().includes(query)) {
                        foundSomething = true;
                        const res = document.createElement('div');
                        res.className = 'list-item search-item card-item';
                        res.innerHTML = `${card.name} <span>${album.name}</span>`;
                        res.onclick = () => renderPuzzle(album, card);
                        viewSearch.appendChild(res);
                    }
                });
            });

            if(!foundSomething) viewSearch.innerHTML += `<p>${i18n[currLang].noMatch}</p>`;
            viewSearch.style.display = 'block';
        });

        // Darabsz√°m m√≥dos√≠t√≥ (vizu√°lis visszajelz√©ssel)
        window.updateQty = function(pieceId, change) {
            let currentQty = userInventory[pieceId] || 0;
            currentQty += change;
            if (currentQty < 0) currentQty = 0; 
            
            userInventory[pieceId] = currentQty; 
            
            let displayQty = currentQty;
            const pieceBox = document.getElementById(`box-${pieceId}`);
            
            pieceBox.classList.remove('piece-missing', 'piece-surplus');
            
            if(currentQty === 0) {
                displayQty = "0";
                pieceBox.classList.add('piece-missing');
            } else if(currentQty === 1) {
                displayQty = "‚úî";
            } else {
                displayQty = `+${currentQty - 1}`;
                pieceBox.classList.add('piece-surplus');
            }
            
            document.getElementById(`qty-${pieceId}`).textContent = displayQty;
        };

        document.getElementById('save-inventory-btn').addEventListener('click', async () => {
            const toast = document.getElementById('toast-msg');
            try {
                await updateDoc(doc(db, "jatekosok", currentUserUid), { inventory: userInventory });
                toast.textContent = "‚úÖ Saved!";
                toast.style.backgroundColor = "rgba(40, 167, 69, 0.95)";
                toast.classList.add("show");
                setTimeout(() => toast.classList.remove("show"), 2000);
            } catch (error) {
                toast.textContent = "‚ùå Error!";
                toast.style.backgroundColor = "rgba(220, 53, 69, 0.95)";
                toast.classList.add("show");
                setTimeout(() => toast.classList.remove("show"), 2000);
            }
        });

        window.runMatchmaker = async function(scope) {
            hideAllViews();
            viewMatchmaker.innerHTML = '<h3>‚è≥...</h3>';
            viewMatchmaker.style.display = 'block';

            const backBtn = document.createElement('button');
            backBtn.className = 'btn btn-back';
            backBtn.textContent = i18n[currLang].backAlbum;
            backBtn.onclick = () => renderAlbums();

            try {
                const myServer = document.getElementById('display-server').textContent;
                const myAlliance = document.getElementById('display-alliance').textContent;

                let q;
                if (scope === 'alliance') {
                    q = query(collection(db, "jatekosok"), where("szerver", "==", myServer), where("szovetseg", "==", myAlliance));
                } else {
                    q = query(collection(db, "jatekosok"), where("szerver", "==", myServer));
                }
                
                const querySnapshot = await getDocs(q);

                let resultsHtml = '';
                let hasMatches = false;

                querySnapshot.forEach((userDoc) => {
                    if (userDoc.id === currentUserUid) return; 

                    const otherData = userDoc.data();
                    const otherInv = otherData.inventory || {};
                    const otherName = `${otherData.jatekNev || otherData.nev} [${otherData.szovetseg}]`; 

                    let giveToMe = []; 
                    let takeFromMe = []; 

                    gameData.forEach(album => {
                        album.cards.forEach(card => {
                            for(let p = 1; p <= 15; p++) {
                                const pieceId = `${card.id}_piece_${p}`;
                                const myQty = userInventory[pieceId] || 0;
                                const otherQty = otherInv[pieceId] || 0;
                                const pieceName = `<b>${album.name}</b><br>${card.name} / ${p}.`;

                                if (myQty === 0 && otherQty >= 2) {
                                    giveToMe.push(`
                                        <div class="trade-row">
                                            <span>üü¢ ${pieceName}</span>
                                            <button class="btn btn-green btn-small" onclick="executeTrade('${userDoc.id}', '${pieceId}', 'receive', this)">${i18n[currLang].traded}</button>
                                        </div>
                                    `);
                                }
                                if (myQty >= 2 && otherQty === 0) {
                                    takeFromMe.push(`
                                        <div class="trade-row">
                                            <span>üîµ ${pieceName}</span>
                                            <button class="btn btn-blue btn-small" onclick="executeTrade('${userDoc.id}', '${pieceId}', 'give', this)">${i18n[currLang].traded}</button>
                                        </div>
                                    `);
                                }
                            }
                        });
                    });

                    if (giveToMe.length > 0 || takeFromMe.length > 0) {
                        hasMatches = true;
                        resultsHtml += `<div class="match-card"><h4>üë§ ${otherName}</h4>`;
                        if (giveToMe.length > 0) {
                            resultsHtml += `<div class="match-detail" style="border-left: 3px solid #6bc85f;">
                                            <b>${i18n[currLang].givesYou}</b><br>${giveToMe.join('')}</div>`;
                        }
                        if (takeFromMe.length > 0) {
                            resultsHtml += `<div class="match-detail" style="border-left: 3px solid #4285F4;">
                                            <b>${i18n[currLang].asksFrom}</b><br>${takeFromMe.join('')}</div>`;
                        }
                        resultsHtml += `</div>`;
                    }
                });

                viewMatchmaker.innerHTML = '';
                viewMatchmaker.appendChild(backBtn);
                viewMatchmaker.insertAdjacentHTML('beforeend', `<h3>ü§ù ${scope === 'alliance' ? myAlliance : myServer}</h3>`);

                if (hasMatches) {
                    viewMatchmaker.insertAdjacentHTML('beforeend', resultsHtml);
                } else {
                    viewMatchmaker.insertAdjacentHTML('beforeend', `<p>${i18n[currLang].noMatch}</p>`);
                }

            } catch (error) {
                console.error(error);
                viewMatchmaker.innerHTML = '<h3>‚ùå Error</h3>';
                viewMatchmaker.appendChild(backBtn);
            }
        };

        window.executeTrade = async function(otherUid, pieceId, type, btnElement) {
            if(!confirm("Are you sure? This updates both inventories!")) return;
            btnElement.disabled = true;
            btnElement.textContent = "‚è≥...";

            try {
                let myChange = (type === 'give') ? -1 : 1;
                let otherChange = (type === 'give') ? 1 : -1;

                await updateDoc(doc(db, "jatekosok", currentUserUid), { [`inventory.${pieceId}`]: increment(myChange) });
                await updateDoc(doc(db, "jatekosok", otherUid), { [`inventory.${pieceId}`]: increment(otherChange) });

                userInventory[pieceId] = (userInventory[pieceId] || 0) + myChange;
                btnElement.textContent = "‚úÖ";
                btnElement.style.backgroundColor = "#555";
            } catch(error) {
                alert("Trade error!");
                btnElement.disabled = false;
                btnElement.textContent = i18n[currLang].traded;
            }
        };
    </script>
</body>
</html>