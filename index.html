<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Whiteout Survival - Tundra Album Csere</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; margin: 0; padding: 20px; background-color: #f4f7f6; }
        .container { background: white; max-width: 800px; margin: auto; padding: 20px; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        input { width: 90%; padding: 10px; margin: 10px 0; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; font-size: 16px;}
        .btn { padding: 10px 20px; margin: 5px 0; font-size: 16px; cursor: pointer; color: white; border: none; border-radius: 5px; font-weight: bold; width: 90%; }
        .btn-blue { background-color: #4285F4; } .btn-blue:hover { background-color: #357ae8; }
        .btn-green { background-color: #28a745; } .btn-green:hover { background-color: #218838; }
        .btn-dark { background-color: #333; } .btn-dark:hover { background-color: #555; }
        .btn-red { background-color: #d9534f; } .btn-red:hover { background-color: #c9302c; }
        .btn-back { background-color: #8892a3; width: auto; padding: 8px 15px; margin-bottom: 15px; }
        
        /* Navig√°ci√≥s diz√°jn */
        .list-item { background: #1a2a40; color: white; padding: 15px; border-radius: 8px; margin: 10px auto; cursor: pointer; font-size: 18px; font-weight: bold; width: 90%; transition: transform 0.1s; text-align: center;}
        .list-item:active { transform: scale(0.98); }
        .card-item { background: #e09f3e; color: white; }
        .search-item { background: #17a2b8; color: white; text-align: left; padding: 10px 15px; }
        .search-item span { display: block; font-size: 12px; color: #eef2f5; font-weight: normal; }

        /* Keres≈ë s√°v √©s F≈ëgombok */
        #search-bar { position: sticky; top: 0; background: white; padding: 10px 0; z-index: 10; border-bottom: 2px solid #eee; margin-bottom: 15px;}
        .action-buttons { display: flex; justify-content: center; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;}
        
        /* Puzzle R√°cs */
        .puzzle-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px; margin-top: 10px; }
        .puzzle-piece { border-radius: 8px; padding: 5px; background: #5a82e6; display: flex; flex-direction: column; align-items: center; justify-content: space-between; min-height: 100px; box-shadow: 0 2px 4px rgba(0,0,0,0.2);}
        .piece-shape { width: 40px; height: 40px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 16px; margin-bottom: 5px;}
        
        .controls { display: flex; align-items: center; justify-content: space-between; width: 100%; background: white; border-radius: 5px; overflow: hidden; }
        .qty-btn { background: #ddd; border: none; padding: 5px 10px; cursor: pointer; font-weight: bold; font-size: 14px; }
        .qty-btn.plus { background: #6bc85f; color: white; }
        .qty-btn.minus { background: #d9534f; color: white; }
        .qty-display { font-weight: bold; color: #333; font-size: 14px;}
        .piece-missing { background: #8892a3; }
        
        /* √öJ: K√©perny≈ë k√∂zep√©n felugr√≥ (Toast) Ment√©s √ârtes√≠t√©s */
        #toast-msg {
            visibility: hidden; min-width: 250px; background-color: rgba(40, 167, 69, 0.95);
            color: #fff; text-align: center; border-radius: 8px; padding: 20px;
            position: fixed; z-index: 1000; left: 50%; top: 50%; transform: translate(-50%, -50%);
            font-size: 20px; font-weight: bold; box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            opacity: 0; transition: opacity 0.4s, visibility 0.4s; pointer-events: none;
        }
        #toast-msg.show { visibility: visible; opacity: 1; }
        
        /* Matchmaker k√°rtya diz√°jn */
        .match-card { background: #2a3b50; color: white; padding: 15px; border-radius: 8px; margin: 10px auto; width: 90%; text-align: left; box-shadow: 0 2px 5px rgba(0,0,0,0.2);}
        .match-card h4 { margin: 0 0 10px 0; color: #ffd700; border-bottom: 1px solid #4a5b70; padding-bottom: 5px;}
        .match-detail { margin: 5px 0; font-size: 14px; background: rgba(0,0,0,0.2); padding: 8px; border-radius: 5px;}
    </style>
</head>
<body>

    <div id="toast-msg">‚úÖ Sikeres ment√©s!</div>

    <div id="auth-screen" class="container">
        <h2>L√©pj be vagy Regisztr√°lj</h2>
        <input type="email" id="email-input" placeholder="E-mail c√≠m">
        <input type="password" id="password-input" placeholder="Jelsz√≥">
        <div id="auth-error" style="color:red"></div>
        <button id="email-login-btn" class="btn btn-green">Bel√©p√©s E-maillel</button>
        <button id="email-register-btn" class="btn btn-dark">√öj fi√≥k regisztr√°l√°sa</button>
        <hr><button id="google-login-btn" class="btn btn-blue">Bel√©p√©s Google fi√≥kkal</button>
    </div>

    <div id="profile-setup-screen" class="container" style="display: none;">
        <h2>Hozd l√©tre a profilod</h2>
        <input type="text" id="player-name" placeholder="J√°t√©kosneved">
        <input type="number" id="server-number" placeholder="Szerver sz√°ma (√Ållam)">
        <input type="text" id="alliance-name" placeholder="Sz√∂vets√©g r√∂vid√≠t√©se">
        <div id="profile-error" style="color:red"></div>
        <button id="save-profile-btn" class="btn btn-green">Ment√©s √©s Tov√°bb</button>
    </div>

    <div id="main-app-screen" class="container" style="display: none;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <div style="text-align: left;">
                <h3 style="margin: 0; color:#4285F4;" id="display-name"></h3>
                <small>√Ållam: <b id="display-server"></b> | Kl√°n: <b id="display-alliance"></b></small>
            </div>
            <button id="logout-btn" class="btn btn-red" style="width: auto; padding: 5px 10px;">Kil√©p√©s</button>
        </div>
        
        <div class="action-buttons">
            <button id="matchmaker-btn" class="btn btn-dark" style="width: 100%;">ü§ù Kivel tudok cser√©lni? (Kl√°n keres≈ë)</button>
        </div>

        <div id="search-bar">
            <input type="text" id="search-input" placeholder="üîç Keres√©s albumra vagy k√°rty√°ra...">
        </div>

        <div id="view-albums"></div>
        <div id="view-cards" style="display: none;"></div>
        <div id="view-puzzle" style="display: none;"></div>
        <div id="view-search-results" style="display: none;"></div>
        <div id="view-matchmaker" style="display: none;"></div> <br><hr><br>
        <button id="save-inventory-btn" class="btn btn-green" style="font-size: 18px; padding: 15px;">üíæ V√°ltoz√°sok Ment√©se</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";
        // √öJ: Behozzuk a collection, query, where, getDocs parancsokat a keres≈ëh√∂z!
        import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

        // IDE M√ÅSOLD BE A SAJ√ÅT KULCSODAT!
        const firebaseConfig = {
  apiKey: "AIzaSyDeEK5nOuvuELtGd61Q7W04uKGcJqG1L1U",
  authDomain: "tundra-album.firebaseapp.com",
  projectId: "tundra-album",
  storageBucket: "tundra-album.firebasestorage.app",
  messagingSenderId: "469371801375",
  appId: "1:469371801375:web:71007b232a98fe8bdbea2a",
  measurementId: "G-2LQT9X23X5"
};
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        let currentUserUid = null;
        let userInventory = {}; 

        // Adatb√°zis (Albumok gener√°l√°sa)
        const albumNames = [
            "Rekindled Flames", "Explore the World", "Daybreak Island", "Tundra Alliance", 
            "Battlefield Epic", "Spectacular Adventures", "Divine Weapons", "Song of Heroes", 
            "The Labyrinth", "Nature‚Äôs Strength", "Crystalline Mysteries", "Ballad of Wind and Cold", 
            "Infernal Power", "Prerogative of the Flame", "Frostdragon Empire", "Kings of Combat"
        ];
        
        const gameData = albumNames.map((name, aIdx) => {
            return {
                id: `album_${aIdx}`,
                name: name,
                cards: Array.from({length: 9}, (_, cIdx) => ({
                    id: `album_${aIdx}_card_${cIdx+1}`,
                    name: `K√°rtya ${cIdx+1}`
                }))
            };
        });

        // K√©perny≈ëk kezel√©se
        const authScreen = document.getElementById('auth-screen');
        const profileScreen = document.getElementById('profile-setup-screen');
        const mainScreen = document.getElementById('main-app-screen');

        function showScreen(screen) {
            authScreen.style.display = 'none'; profileScreen.style.display = 'none'; mainScreen.style.display = 'none';
            screen.style.display = 'block';
        }

        document.getElementById('email-register-btn').addEventListener('click', () => createUserWithEmailAndPassword(auth, document.getElementById('email-input').value, document.getElementById('password-input').value).catch(e => document.getElementById('auth-error').textContent = e.message));
        document.getElementById('email-login-btn').addEventListener('click', () => signInWithEmailAndPassword(auth, document.getElementById('email-input').value, document.getElementById('password-input').value).catch(e => document.getElementById('auth-error').textContent = "Hib√°s adat."));
        document.getElementById('google-login-btn').addEventListener('click', () => signInWithPopup(auth, provider).catch(e => console.error(e)));
        document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));

        document.getElementById('save-profile-btn').addEventListener('click', async () => {
            const pName = document.getElementById('player-name').value;
            const pServer = document.getElementById('server-number').value;
            const pAlliance = document.getElementById('alliance-name').value;
            if(!pName || !pServer || !pAlliance) return document.getElementById('profile-error').textContent = "T√∂lts ki mindent!";
            await setDoc(doc(db, "jatekosok", currentUserUid), { jatekNev: pName, szerver: pServer, szovetseg: pAlliance, inventory: {} });
            checkUserProfile(currentUserUid);
        });

        async function checkUserProfile(uid) {
            const docSnap = await getDoc(doc(db, "jatekosok", uid));
            if (docSnap.exists() && docSnap.data().szerver) {
                const data = docSnap.data();
                document.getElementById('display-name').textContent = data.jatekNev || data.nev;
                document.getElementById('display-server').textContent = data.szerver;
                document.getElementById('display-alliance').textContent = data.szovetseg;
                userInventory = data.inventory || {}; 
                renderAlbums(); 
                showScreen(mainScreen);
            } else {
                showScreen(profileScreen);
            }
        }

        onAuthStateChanged(auth, (user) => {
            if (user) { currentUserUid = user.uid; checkUserProfile(user.uid); } 
            else { currentUserUid = null; showScreen(authScreen); }
        });

        // UI N√©zetek
        const viewAlbums = document.getElementById('view-albums');
        const viewCards = document.getElementById('view-cards');
        const viewPuzzle = document.getElementById('view-puzzle');
        const viewSearch = document.getElementById('view-search-results');
        const viewMatchmaker = document.getElementById('view-matchmaker'); // √öj n√©zet
        const searchInput = document.getElementById('search-input');

        function hideAllViews() {
            viewAlbums.style.display = 'none'; viewCards.style.display = 'none';
            viewPuzzle.style.display = 'none'; viewSearch.style.display = 'none';
            viewMatchmaker.style.display = 'none';
        }

        function renderAlbums() {
            hideAllViews();
            searchInput.value = ''; 
            viewAlbums.innerHTML = '<h3>V√°lassz egy Albumot:</h3>';
            gameData.forEach(album => {
                const btn = document.createElement('div');
                btn.className = 'list-item';
                btn.textContent = `üìñ ${album.name}`;
                btn.onclick = () => renderCards(album);
                viewAlbums.appendChild(btn);
            });
            viewAlbums.style.display = 'block';
        }

        function renderCards(album) {
            hideAllViews();
            searchInput.value = '';
            viewCards.innerHTML = '';
            
            const backBtn = document.createElement('button');
            backBtn.className = 'btn btn-back';
            backBtn.textContent = '‚¨Ö Vissza az Albumokhoz';
            backBtn.onclick = () => renderAlbums();
            
            viewCards.appendChild(backBtn);
            viewCards.insertAdjacentHTML('beforeend', `<h3>üìñ ${album.name}</h3>`);
            
            album.cards.forEach(card => {
                const btn = document.createElement('div');
                btn.className = 'list-item card-item';
                btn.textContent = card.name;
                btn.onclick = () => renderPuzzle(album, card);
                viewCards.appendChild(btn);
            });
            viewCards.style.display = 'block';
        }

        function renderPuzzle(album, card) {
            hideAllViews();
            searchInput.value = '';
            viewPuzzle.innerHTML = '';
            
            const backBtn = document.createElement('button');
            backBtn.className = 'btn btn-back';
            backBtn.textContent = '‚¨Ö Vissza a K√°rty√°khoz';
            backBtn.onclick = () => renderCards(album);
            
            viewPuzzle.appendChild(backBtn);
            viewPuzzle.insertAdjacentHTML('beforeend', `<h3><small>${album.name}</small><br>${card.name}</h3>`);
            
            const grid = document.createElement('div');
            grid.className = 'puzzle-grid';

            for(let p = 1; p <= 15; p++) {
                const pieceId = `${card.id}_piece_${p}`;
                const currentQty = userInventory[pieceId] || 0; 
                
                const pieceDiv = document.createElement('div');
                pieceDiv.className = `puzzle-piece ${currentQty === 0 ? 'piece-missing' : ''}`;
                
                pieceDiv.innerHTML = `
                    <div class="piece-shape">${p}</div>
                    <div class="controls">
                        <button class="qty-btn minus" onclick="updateQty('${pieceId}', -1)">-</button>
                        <span class="qty-display" id="qty-${pieceId}">${currentQty}</span>
                        <button class="qty-btn plus" onclick="updateQty('${pieceId}', 1)">+</button>
                    </div>
                `;
                grid.appendChild(pieceDiv);
            }
            viewPuzzle.appendChild(grid);
            viewPuzzle.style.display = 'block';
        }

        searchInput.addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase().trim();
            if(query === '') return renderAlbums();

            hideAllViews();
            viewSearch.innerHTML = `<h3>Tal√°latok erre: "${query}"</h3>`;
            let foundSomething = false;

            gameData.forEach(album => {
                if(album.name.toLowerCase().includes(query)) {
                    foundSomething = true;
                    const res = document.createElement('div');
                    res.className = 'list-item search-item';
                    res.innerHTML = `üìñ ${album.name} <span>(Ugr√°s az album k√°rty√°ihoz)</span>`;
                    res.onclick = () => renderCards(album);
                    viewSearch.appendChild(res);
                }
                album.cards.forEach(card => {
                    if(card.name.toLowerCase().includes(query)) {
                        foundSomething = true;
                        const res = document.createElement('div');
                        res.className = 'list-item search-item card-item';
                        res.innerHTML = `${card.name} <span>Album: ${album.name}</span>`;
                        res.onclick = () => renderPuzzle(album, card);
                        viewSearch.appendChild(res);
                    }
                });
            });

            if(!foundSomething) viewSearch.innerHTML += '<p>Nincs tal√°lat.</p>';
            viewSearch.style.display = 'block';
        });

        window.updateQty = function(pieceId, change) {
            let currentQty = userInventory[pieceId] || 0;
            currentQty += change;
            if (currentQty < 0) currentQty = 0; 
            
            userInventory[pieceId] = currentQty; 
            document.getElementById(`qty-${pieceId}`).textContent = currentQty;
            
            const pieceBox = document.getElementById(`qty-${pieceId}`).closest('.puzzle-piece');
            if(currentQty === 0) pieceBox.classList.add('piece-missing');
            else pieceBox.classList.remove('piece-missing');
        };

        // Ment√©s (K√∂z√©pre ugr√≥ Toast √úzenettel)
        document.getElementById('save-inventory-btn').addEventListener('click', async () => {
            const toast = document.getElementById('toast-msg');
            
            try {
                await updateDoc(doc(db, "jatekosok", currentUserUid), { inventory: userInventory });
                
                // Megjelen√≠tj√ºk a z√∂ld √ºzenetet a k√©perny≈ë k√∂zep√©n!
                toast.textContent = "‚úÖ Sikeres ment√©s!";
                toast.style.backgroundColor = "rgba(40, 167, 69, 0.95)";
                toast.classList.add("show");
                
                // 3 m√°sodperc m√∫lva elt√ºntetj√ºk
                setTimeout(() => toast.classList.remove("show"), 3000);
            } catch (error) {
                console.error("Hiba:", error);
                toast.textContent = "‚ùå Hiba a ment√©sn√©l!";
                toast.style.backgroundColor = "rgba(220, 53, 69, 0.95)";
                toast.classList.add("show");
                setTimeout(() => toast.classList.remove("show"), 3000);
            }
        });

        // --- √öJ: A KL√ÅN CSERE-KERES≈ê MOTOR ---
        document.getElementById('matchmaker-btn').addEventListener('click', async () => {
            hideAllViews();
            viewMatchmaker.innerHTML = '<h3>‚è≥ Adatb√°zis elemz√©se...</h3>';
            viewMatchmaker.style.display = 'block';

            const backBtn = document.createElement('button');
            backBtn.className = 'btn btn-back';
            backBtn.textContent = '‚¨Ö Vissza a f≈ëoldalra';
            backBtn.onclick = () => renderAlbums();

            try {
                const myServer = document.getElementById('display-server').textContent;
                const myAlliance = document.getElementById('display-alliance').textContent;

                // Lek√©rj√ºk a Firebase-b≈ël csak azokat az embereket, akik ugyanazon a szerveren √©s kl√°nban vannak!
                const q = query(collection(db, "jatekosok"), where("szerver", "==", myServer), where("szovetseg", "==", myAlliance));
                const querySnapshot = await getDocs(q);

                let resultsHtml = '';
                let hasMatches = false;

                querySnapshot.forEach((userDoc) => {
                    if (userDoc.id === currentUserUid) return; // Magunkkal nem cser√©l√ºnk

                    const otherData = userDoc.data();
                    const otherInv = otherData.inventory || {};
                    const otherName = otherData.jatekNev || otherData.nev || "Ismeretlen J√°t√©kos";

                    let giveToMe = []; // Neki 2+ van, nekem 0
                    let takeFromMe = []; // Nekem 2+ van, neki 0

                    // V√©gigmegy√ºnk az √∂sszes k√°rty√°n √©s √∂sszehasonl√≠tjuk
                    gameData.forEach(album => {
                        album.cards.forEach(card => {
                            for(let p = 1; p <= 15; p++) {
                                const pieceId = `${card.id}_piece_${p}`;
                                const myQty = userInventory[pieceId] || 0;
                                const otherQty = otherInv[pieceId] || 0;

                                const pieceName = `<b>${album.name}</b> / ${card.name} / ${p}. db`;

                                if (myQty === 0 && otherQty >= 2) {
                                    giveToMe.push(`üü¢ ${pieceName}`); // ≈ê adja nekem
                                }
                                if (myQty >= 2 && otherQty === 0) {
                                    takeFromMe.push(`üîµ ${pieceName}`); // √ân adom neki
                                }
                            }
                        });
                    });

                    // Ha b√°rmelyik ir√°nyba van tal√°lat, ki√≠rjuk a j√°t√©kost!
                    if (giveToMe.length > 0 || takeFromMe.length > 0) {
                        hasMatches = true;
                        resultsHtml += `<div class="match-card"><h4>üë§ ${otherName}</h4>`;
                        
                        if (giveToMe.length > 0) {
                            resultsHtml += `<div class="match-detail" style="border-left: 3px solid #6bc85f;">
                                            <b>Tud adni neked:</b><br>${giveToMe.join('<br>')}</div>`;
                        }
                        if (takeFromMe.length > 0) {
                            resultsHtml += `<div class="match-detail" style="border-left: 3px solid #4285F4;">
                                            <b>K√©ri t≈ëled:</b><br>${takeFromMe.join('<br>')}</div>`;
                        }
                        resultsHtml += `</div>`;
                    }
                });

                viewMatchmaker.innerHTML = '';
                viewMatchmaker.appendChild(backBtn);
                viewMatchmaker.insertAdjacentHTML('beforeend', `<h3>ü§ù Cserepartnerek (${myAlliance})</h3>`);

                if (hasMatches) {
                    viewMatchmaker.insertAdjacentHTML('beforeend', resultsHtml);
                } else {
                    viewMatchmaker.insertAdjacentHTML('beforeend', `<p>Sajnos jelenleg nincs olyan kl√°nt√°rsad, akivel oda-vissza cser√©lni tudn√°l.</p>`);
                }

            } catch (error) {
                console.error(error);
                viewMatchmaker.innerHTML = '<h3>‚ùå Hiba t√∂rt√©nt a keres√©s k√∂zben.</h3>';
                viewMatchmaker.appendChild(backBtn);
            }
        });
    </script>
</body>
</html>