<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Whiteout Survival - Tundra Trade</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; text-align: center; margin: 0; padding: 20px; background: linear-gradient(135deg, #0f2027, #203a43, #2c5364); color: #eef2f5; min-height: 100vh; }
        .container { background: rgba(25, 35, 50, 0.6); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); max-width: 800px; margin: auto; padding: 30px; border-radius: 15px; box-shadow: 0 8px 32px rgba(0,0,0,0.5); }
        h2, h3 { color: #ffffff; text-shadow: 1px 1px 3px rgba(0,0,0,0.5); }
        input, select { width: 90%; padding: 12px; margin: 10px 0; background: rgba(255, 255, 255, 0.9); border: 2px solid transparent; border-radius: 8px; box-sizing: border-box; font-size: 16px; color: #333; transition: all 0.3s; }
        input:focus { border-color: #4285F4; outline: none; box-shadow: 0 0 10px rgba(66, 133, 244, 0.5); }
        
        .btn { padding: 12px 20px; margin: 5px 0; font-size: 16px; cursor: pointer; color: white; border: none; border-radius: 8px; font-weight: bold; width: 90%; text-transform: uppercase; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        .btn:active { transform: scale(0.97); }
        .btn-blue { background: linear-gradient(90deg, #4285F4, #357ae8); } 
        .btn-green { background: linear-gradient(90deg, #28a745, #218838); } 
        .btn-dark { background: linear-gradient(90deg, #333, #555); } 
        .btn-red { background: linear-gradient(90deg, #d9534f, #c9302c); } 
        .btn-back { background-color: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); width: auto; padding: 8px 15px; margin-bottom: 15px; text-transform: none;}
        .btn-small { padding: 6px 12px; font-size: 14px; margin-left: 10px; width: auto; box-shadow: none;}
        
        .list-item { background: rgba(0, 0, 0, 0.4); border: 1px solid rgba(255,255,255,0.05); color: white; padding: 15px; border-radius: 10px; margin: 10px auto; cursor: pointer; width: 90%; transition: transform 0.1s, background 0.2s; text-align: left; }
        .list-item:hover { background: rgba(0, 0, 0, 0.6); }
        .list-item:active { transform: scale(0.98); }
        .card-item { background: rgba(224, 159, 62, 0.2); border-left: 4px solid #e09f3e; display: flex; justify-content: space-between; align-items: center; font-weight: bold; font-size: 18px;}
        
        .album-row { display: flex; align-items: center; justify-content: flex-start; width: 100%; }
        .album-img { width: 65px; height: 65px; border-radius: 10px; object-fit: cover; margin-right: 20px; background: rgba(0,0,0,0.5); border: 2px solid rgba(255,255,255,0.2); }
        .album-info { flex-grow: 1; display: flex; flex-direction: column; justify-content: center; }
        .album-name { font-size: 20px; font-weight: bold; margin-bottom: 8px; color: #fff;}
        .progress-bg { width: 100%; height: 14px; background: rgba(0,0,0,0.6); border-radius: 7px; overflow: hidden; border: 1px solid rgba(255,255,255,0.1); position: relative;}
        .progress-bar { height: 100%; background: linear-gradient(90deg, #28a745, #34ce57); width: 0%; transition: width 0.4s ease; }
        .progress-text { font-size: 13px; color: #ddd; text-align: right; margin-top: 4px; font-weight: normal;}

        #top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.1);}
        #lang-selector { width: auto; padding: 8px; margin: 0; font-size: 14px; background: rgba(255,255,255,0.9); color: #000; border-radius: 5px;}
        .action-buttons { display: flex; justify-content: center; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;}
        #search-bar { position: sticky; top: 0; background: rgba(25, 35, 50, 0.95); padding: 10px 0; z-index: 10; border-radius: 10px; margin-bottom: 15px; backdrop-filter: blur(5px);}
        
        .puzzle-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(110px, 1fr)); gap: 12px; margin-top: 15px; }
        .puzzle-piece { border-radius: 10px; padding: 8px; background: linear-gradient(135deg, #4b6cb7, #182848); display: flex; flex-direction: column; align-items: center; justify-content: space-between; min-height: 110px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); outline: none; transition: transform 0.1s; }
        .puzzle-piece:focus { border: 2px solid #ffc107; transform: scale(1.05); }
        .piece-shape { width: 45px; height: 45px; background: rgba(255,255,255,0.15); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 18px; margin-bottom: 8px; border: 1px solid rgba(255,255,255,0.2);}
        .controls { display: flex; align-items: center; justify-content: space-between; width: 100%; background: rgba(0,0,0,0.4); border-radius: 6px; overflow: hidden; padding: 2px;}
        .qty-btn { background: transparent; border: none; padding: 5px 10px; cursor: pointer; font-weight: bold; font-size: 16px; color: white; transition: background 0.2s;}
        .qty-btn:hover { background: rgba(255,255,255,0.2); }
        .qty-display { font-weight: bold; color: #fff; font-size: 16px;}
        .piece-missing { background: linear-gradient(135deg, #4a5568, #2d3748); opacity: 0.8;}
        .piece-surplus { background: linear-gradient(135deg, #2b5876, #4e4376); }
        
        .check-btn { width: 34px; height: 34px; border-radius: 6px; border: 2px solid rgba(255,255,255,0.5); display: flex; align-items: center; justify-content: center; font-size: 20px; cursor: pointer; transition: all 0.2s; background: rgba(0,0,0,0.2); }
        .check-btn.checked { background-color: #28a745; border-color: #28a745; color: white; box-shadow: 0 0 10px rgba(40,167,69,0.5);}
        .check-btn.unchecked { color: transparent; }
        .check-btn.unchecked:hover { background-color: rgba(255,255,255,0.1); border-color: white;}

        #toast-msg { visibility: hidden; min-width: 250px; background-color: rgba(40, 167, 69, 0.95); color: #fff; text-align: center; border-radius: 8px; padding: 15px; position: fixed; z-index: 1000; left: 50%; top: 50%; transform: translate(-50%, -50%); font-size: 18px; font-weight: bold; box-shadow: 0 4px 15px rgba(0,0,0,0.5); opacity: 0; transition: opacity 0.3s, visibility 0.3s; pointer-events: none; backdrop-filter: blur(5px); }
        #toast-msg.show { visibility: visible; opacity: 1; }
        
        .match-card { background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); color: white; padding: 15px; border-radius: 10px; margin: 15px auto; width: 90%; text-align: left; box-shadow: 0 4px 6px rgba(0,0,0,0.2);}
        .match-card h4 { margin: 0 0 10px 0; color: #e09f3e; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 8px; font-size: 20px;}
        .match-detail { margin: 8px 0; font-size: 14px; background: rgba(0,0,0,0.4); padding: 10px; border-radius: 8px;}
        .trade-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; border-bottom: 1px dashed rgba(255,255,255,0.1); padding-bottom: 8px;}
        
        hr { border: 0; border-top: 1px solid rgba(255,255,255,0.1); margin: 25px 0;}
    </style>
</head>
<body>

    <div id="toast-msg">‚úÖ Saved!</div>

    <div id="auth-screen" class="container">
        <div style="margin-bottom: 30px;">
            <h1 style="color: #e09f3e; font-size: 32px; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 2px;">Whiteout Survival</h1>
            <h2 style="color: #fff; margin-top: 0; font-weight: normal; font-size: 22px;">‚ùÑÔ∏è Tundra Trade ‚ùÑÔ∏è</h2>
            <p style="color: #aaa; font-style: italic;">The Ultimate Puzzle Exchange Tool</p>
        </div>
        <input type="email" id="email-input" placeholder="Email address">
        <input type="password" id="password-input" placeholder="Password">
        <div id="auth-error" style="color:#ff6b6b; margin-bottom:10px; font-weight:bold;"></div>
        <button id="email-login-btn" class="btn btn-green">Login with Email</button>
        <button id="email-register-btn" class="btn btn-dark">Register new account</button>
        <div style="margin: 20px 0; color: #888; display: flex; align-items: center; justify-content: center;">
            <hr style="flex-grow: 1; margin: 0 15px;"><span style="font-size: 14px;">OR</span><hr style="flex-grow: 1; margin: 0 15px;">
        </div>
        <button id="google-login-btn" class="btn btn-blue">Login with Google</button>
    </div>

    <div id="profile-setup-screen" class="container" style="display: none;">
        <h2 style="color: #e09f3e;">Setup your profile</h2>
        <input type="text" id="player-name" placeholder="Player Name (any characters)">
        <input type="number" id="server-number" placeholder="State/Server (exactly 4 digits, e.g., 2530)">
        <input type="text" id="alliance-name" placeholder="Alliance Tag (exactly 3 chars, e.g., ABC)">
        <div id="profile-error" style="color:#ff6b6b; margin-bottom:10px; font-weight:bold;"></div>
        <button id="save-profile-btn" class="btn btn-green">Save & Continue</button>
    </div>

    <div id="main-app-screen" class="container" style="display: none;">
        <div id="top-bar">
            <div style="text-align: left;">
                <h3 style="margin: 0; color:#e09f3e;" id="display-name"></h3>
                <small style="color: #ccc;"><span class="t-state">State</span>: <b id="display-server" style="color:#fff;"></b> | <span class="t-alliance">Alliance</span>: <b id="display-alliance" style="color:#fff;"></b></small>
            </div>
            <div>
                <select id="lang-selector" onchange="window.changeLanguage(this.value)">
                    <option value="en" selected>üá¨üáß English</option>
                    <option value="hu">üá≠üá∫ Magyar</option>
                    <option value="de">üá©üá™ Deutsch</option>
                    <option value="fr">üá´üá∑ Fran√ßais</option>
                    <option value="tr">üáπüá∑ T√ºrk√ße</option>
                    <option value="ru">üá∑üá∫ –†—É—Å—Å–∫–∏–π</option>
                    <option value="ar">üá∏üá¶ ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
                </select>
            </div>
        </div>
        
        <div class="action-buttons">
            <button onclick="window.runMatchmaker('alliance')" class="btn btn-blue t-btn-clan" style="width: 48%; box-shadow: 0 4px 15px rgba(66, 133, 244, 0.4);">ü§ù Search in Clan</button>
            <button onclick="window.runMatchmaker('state')" class="btn btn-dark t-btn-state" style="width: 48%;">üåç Search in State</button>
        </div>

        <div id="search-bar">
            <input type="text" id="search-input" class="t-search-ph" placeholder="üîç Search album or card...">
        </div>

        <div id="view-albums"></div>
        <div id="view-cards" style="display: none;"></div>
        <div id="view-puzzle" style="display: none;"></div>
        <div id="view-search-results" style="display: none;"></div>
        <div id="view-matchmaker" style="display: none;"></div>

        <br><hr>
        <button id="save-inventory-btn" class="btn btn-green t-btn-save" style="font-size: 18px; padding: 15px; box-shadow: 0 4px 15px rgba(40, 167, 69, 0.4);">üíæ Save Changes</button>
        <br><br>
        <button id="logout-btn" class="btn btn-back t-btn-logout" style="width: auto; background: transparent;">Logout</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, query, where, getDocs, increment } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

        // IDE M√ÅSOLD BE A SAJ√ÅT KULCSODAT!
 const firebaseConfig = {
  apiKey: "AIzaSyDeEK5nOuvuELtGd61Q7W04uKGcJqG1L1U",
  authDomain: "tundra-album.firebaseapp.com",
  projectId: "tundra-album",
  storageBucket: "tundra-album.firebasestorage.app",
  messagingSenderId: "469371801375",
  appId: "1:469371801375:web:71007b232a98fe8bdbea2a",
  measurementId: "G-2LQT9X23X5"
};
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        let currentUserUid = null;
        let userInventory = {}; 
        let currentAlbumGlobal = null;
        let currentCardGlobal = null;

        const i18n = {
            en: { state: "State", alliance: "Alliance", btnClan: "ü§ù Search in Clan", btnState: "üåç Search in State", searchPh: "üîç Search album or card...", btnSave: "üíæ Save Changes", btnLogout: "Logout", backAlbum: "‚¨Ö Back to Albums", backCard: "‚¨Ö Back to Cards", markDone: "‚úî Set missing to 1", cardsOwnedInfo: "Completed Cards", givesYou: "They can give you:", asksFrom: "They ask from you:", traded: "Traded!", noMatch: "No matching players found." },
            hu: { state: "√Ållam", alliance: "Sz√∂vets√©g", btnClan: "ü§ù Keres√©s Kl√°nban", btnState: "üåç Keres√©s √Ållamban", searchPh: "üîç Keres√©s albumra vagy k√°rty√°ra...", btnSave: "üíæ V√°ltoz√°sok Ment√©se", btnLogout: "Kijelentkez√©s", backAlbum: "‚¨Ö Vissza az Albumokhoz", backCard: "‚¨Ö Vissza a K√°rty√°khoz", markDone: "‚úî Hi√°nyz√≥k 1-re √°ll√≠t√°sa", cardsOwnedInfo: "Ezek a k√°rty√°k megvannak", givesYou: "Tud adni neked:", asksFrom: "K√©ri t≈ëled:", traded: "Elcser√©lt√ºk!", noMatch: "Nincs tal√°lat a cserepartnerekre." },
            de: { state: "Staat", alliance: "Allianz", btnClan: "ü§ù Suche im Clan", btnState: "üåç Suche im Staat", searchPh: "üîç Album oder Karte suchen...", btnSave: "üíæ Speichern", btnLogout: "Abmelden", backAlbum: "‚¨Ö Zur√ºck", backCard: "‚¨Ö Zur√ºck", markDone: "‚úî Fehlende auf 1", cardsOwnedInfo: "Komplette Karten", givesYou: "Kann dir geben:", asksFrom: "Fragt von dir:", traded: "Gehandelt!", noMatch: "Keine passenden Spieler gefunden." },
            fr: { state: "√âtat", alliance: "Alliance", btnClan: "ü§ù Chercher dans le Clan", btnState: "üåç Chercher dans l'√âtat", searchPh: "üîç Chercher un album...", btnSave: "üíæ Sauvegarder", btnLogout: "D√©connexion", backAlbum: "‚¨Ö Retour", backCard: "‚¨Ö Retour", markDone: "‚úî Marquer manquants √† 1", cardsOwnedInfo: "Cartes compl√®tes", givesYou: "Peut vous donner:", asksFrom: "Vous demande:", traded: "√âchang√©!", noMatch: "Aucun joueur correspondant." },
            tr: { state: "Eyalet", alliance: "ƒ∞ttifak", btnClan: "ü§ù Klanda Ara", btnState: "üåç Eyalette Ara", searchPh: "üîç Alb√ºm veya kart ara...", btnSave: "üíæ Kaydet", btnLogout: "√áƒ±kƒ±≈ü Yap", backAlbum: "‚¨Ö Alb√ºmlere D√∂n", backCard: "‚¨Ö Kartlara D√∂n", markDone: "‚úî Eksikleri 1 yap", cardsOwnedInfo: "Tamamlanan kartlar", givesYou: "Sana verebilir:", asksFrom: "Senden istiyor:", traded: "Takas edildi!", noMatch: "E≈üle≈üen oyuncu bulunamadƒ±." },
            ru: { state: "–®—Ç–∞—Ç", alliance: "–ê–ª—å—è–Ω—Å", btnClan: "ü§ù –ü–æ–∏—Å–∫ –≤ –∫–ª–∞–Ω–µ", btnState: "üåç –ü–æ–∏—Å–∫ –≤ —à—Ç–∞—Ç–µ", searchPh: "üîç –ü–æ–∏—Å–∫ –∞–ª—å–±–æ–º–∞ –∏–ª–∏ –∫–∞—Ä—Ç—ã...", btnSave: "üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å", btnLogout: "–í—ã–π—Ç–∏", backAlbum: "‚¨Ö –ù–∞–∑–∞–¥", backCard: "‚¨Ö –ù–∞–∑–∞–¥", markDone: "‚úî –ù–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –Ω–∞ 1", cardsOwnedInfo: "–°–æ–±—Ä–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç—ã", givesYou: "–ú–æ–∂–µ—Ç –¥–∞—Ç—å –≤–∞–º:", asksFrom: "–ü—Ä–æ—Å–∏—Ç —É –≤–∞—Å:", traded: "–û–±–º–µ–Ω—è–ª–∏—Å—å!", noMatch: "–ò–≥—Ä–æ–∫–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ." },
            ar: { state: "ÿ≠ÿßŸÑÿ©", alliance: "ÿ™ÿ≠ÿßŸÑŸÅ", btnClan: "ü§ù ÿßŸÑÿ®ÿ≠ÿ´ ŸÅŸä ÿßŸÑÿπÿ¥Ÿäÿ±ÿ©", btnState: "üåç ÿßŸÑÿ®ÿ≠ÿ´ ŸÅŸä ÿßŸÑŸàŸÑÿßŸäÿ©", searchPh: "üîç ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿ£ŸÑÿ®ŸàŸÖ ÿ£Ÿà ÿ®ÿ∑ÿßŸÇÿ©...", btnSave: "üíæ ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿ∫ŸäŸäÿ±ÿßÿ™", btnLogout: "ÿ™ÿ≥ÿ¨ŸäŸÑ ÿÆÿ±Ÿàÿ¨", backAlbum: "‚¨Ö ÿßŸÑÿπŸàÿØÿ© ŸÑŸÑÿ£ŸÑÿ®ŸàŸÖÿßÿ™", backCard: "‚¨Ö ÿßŸÑÿπŸàÿØÿ© ŸÑŸÑÿ®ÿ∑ÿßŸÇÿßÿ™", markDone: "‚úî ÿ™ÿπŸäŸäŸÜ ÿßŸÑŸÖŸÅŸÇŸàÿØ ÿ•ŸÑŸâ 1", cardsOwnedInfo: "ÿ®ÿ∑ÿßŸÇÿßÿ™ ŸÖŸÉÿ™ŸÖŸÑÿ©", givesYou: "ŸäŸÖŸÉŸÜ ÿ£ŸÜ Ÿäÿπÿ∑ŸäŸÉ:", asksFrom: "Ÿäÿ∑ŸÑÿ® ŸÖŸÜŸÉ:", traded: "ÿ™ŸÖ ÿßŸÑÿ™ÿ®ÿßÿØŸÑ!", noMatch: "ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ŸÑÿßÿπÿ®ŸäŸÜ." }
        };
        let currLang = 'en';

        // --- GLOB√ÅLIS FUNKCI√ìK A HTML GOMBOKHOZ ---
        window.changeLanguage = function(lang) {
            currLang = lang;
            document.querySelector('.t-state').textContent = i18n[lang].state;
            document.querySelector('.t-alliance').textContent = i18n[lang].alliance;
            document.querySelector('.t-btn-clan').textContent = i18n[lang].btnClan;
            document.querySelector('.t-btn-state').textContent = i18n[lang].btnState;
            document.querySelector('.t-search-ph').placeholder = i18n[lang].searchPh;
            document.querySelector('.t-btn-save').textContent = i18n[lang].btnSave;
            document.querySelector('.t-btn-logout').textContent = i18n[lang].btnLogout;
            
            if(document.getElementById('view-albums').style.display === 'block') window.renderAlbums();
            if(document.getElementById('view-cards').style.display === 'block') window.renderCards(currentAlbumGlobal);
            if(document.getElementById('view-puzzle').style.display === 'block') window.renderPuzzle(currentAlbumGlobal, currentCardGlobal);
        };

        // ITT VAN MIND A 16 ALBUM! A k√©pek neveit itt tudod √°t√≠rni a saj√°todra!
        const albumAdatok = [
            { id: "album_0", kepFajlNev: "album_0.jpg", en: "Rekindled Flames", de: "Wiederentfachte Flammen", hu: "√öjra√©led≈ë L√°ngok", fr: "Flammes raviv√©es", tr: "Yeniden Alevlenen", ru: "–í–Ω–æ–≤—å –∑–∞–∂–∂–µ–Ω–Ω–æ–µ", ar: "ŸÜŸäÿ±ÿßŸÜ ŸÖÿ¥ÿ™ÿπŸÑÿ©" },
            { id: "album_1", kepFajlNev: "album_1.jpg", en: "Explore the World", de: "Erkunde die Welt", hu: "Fedezd fel a Vil√°got", fr: "Explorer le monde", tr: "D√ºnyayƒ± Ke≈üfet", ru: "–ò—Å—Å–ª–µ–¥—É–π –º–∏—Ä", ar: "ÿßÿ≥ÿ™ŸÉÿ¥ŸÅ ÿßŸÑÿπÿßŸÑŸÖ" },
            { id: "album_2", kepFajlNev: "Daybreak_Island.jpg", en: "Daybreak Island", de: "Insel des Tagesanbruchs", hu: "Hajnal Sziget", fr: "√éle de l'Aube", tr: "≈ûafak Adasƒ±", ru: "–û—Å—Ç—Ä–æ–≤ –†–∞—Å—Å–≤–µ—Ç–∞", ar: "ÿ¨ÿ≤Ÿäÿ±ÿ© ÿßŸÑŸÅÿ¨ÿ±" },
            { id: "album_3", kepFajlNev: "album_3.jpg", en: "Tundra Alliance", de: "Tundra-Allianz", hu: "Tundra Sz√∂vets√©g", fr: "Alliance de la Toundra", tr: "Tundra ƒ∞ttifakƒ±", ru: "–ê–ª—å—è–Ω—Å –¢—É–Ω–¥—Ä—ã", ar: "ÿ™ÿ≠ÿßŸÑŸÅ ÿßŸÑÿ™ŸÜÿØÿ±ÿß" },
            { id: "album_4", kepFajlNev: "album_4.jpg", en: "Battlefield Epic", de: "Schlachtfeld-Epos", hu: "Csatat√©ri Eposz", fr: "√âpop√©e du champ de bataille", tr: "Sava≈ü Alanƒ± Destanƒ±", ru: "–≠–ø–æ—Å –ø–æ–ª—è –±–æ—è", ar: "ŸÖŸÑÿ≠ŸÖÿ© ÿ≥ÿßÿ≠ÿ© ÿßŸÑŸÖÿπÿ±ŸÉÿ©" },
            { id: "album_5", kepFajlNev: "album_5.jpg", en: "Spectacular Adventures", de: "Spektakul√§re Abenteuer", hu: "K√ºl√∂nleges Kalandok", fr: "Aventures spectaculaires", tr: "Muhte≈üem Maceralar", ru: "–ó–∞—Ö–≤–∞—Ç—ã–≤–∞—é—â–∏–µ –ø—Ä–∏–∫–ª—é—á–µ–Ω–∏—è", ar: "ŸÖÿ∫ÿßŸÖÿ±ÿßÿ™ ŸÖÿ∞ŸáŸÑÿ©" },
            { id: "album_6", kepFajlNev: "album_6.jpg", en: "Divine Weapons", de: "G√∂ttliche Waffen", hu: "Isteni Fegyverek", fr: "Armes divines", tr: "ƒ∞lahi Silahlar", ru: "–ë–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ –æ—Ä—É–∂–∏–µ", ar: "ÿ£ÿ≥ŸÑÿ≠ÿ© ÿ•ŸÑŸáŸäÿ©" },
            { id: "album_7", kepFajlNev: "album_7.jpg", en: "Song of Heroes", de: "Heldenlied", hu: "H≈ës√∂k √âneke", fr: "Chant des H√©ros", tr: "Kahramanlarƒ±n ≈ûarkƒ±sƒ±", ru: "–ü–µ—Å–Ω—å –ì–µ—Ä–æ–µ–≤", ar: "ÿ£ÿ∫ŸÜŸäÿ© ÿßŸÑÿ£ÿ®ÿ∑ÿßŸÑ" },
            { id: "album_8", kepFajlNev: "album_8.jpg", en: "The Labyrinth", de: "Das Labyrinth", hu: "A Labirintus", fr: "Le Labyrinthe", tr: "Labirent", ru: "–õ–∞–±–∏—Ä–∏–Ω—Ç", ar: "ÿßŸÑŸÖÿ™ÿßŸáÿ©" },
            { id: "album_9", kepFajlNev: "album_9.jpg", en: "Nature‚Äôs Strength", de: "Kraft der Natur", hu: "A Term√©szet Ereje", fr: "Force de la Nature", tr: "Doƒüanƒ±n G√ºc√º", ru: "–°–∏–ª–∞ –ø—Ä–∏—Ä–æ–¥—ã", ar: "ŸÇŸàÿ© ÿßŸÑÿ∑ÿ®Ÿäÿπÿ©" },
            { id: "album_10", kepFajlNev: "album_10.jpg", en: "Crystalline Mysteries", de: "Kristalline Geheimnisse", hu: "Krist√°lyos Rejt√©lyek", fr: "Myst√®res Cristallins", tr: "Kristal Gizemler", ru: "–ö—Ä–∏—Å—Ç–∞–ª—å–Ω—ã–µ —Ç–∞–π–Ω—ã", ar: "ÿ£ÿ≥ÿ±ÿßÿ± ÿ®ŸÑŸàÿ±Ÿäÿ©" },
            { id: "album_11", kepFajlNev: "album_11.jpg", en: "Ballad of Wind and Cold", de: "Ballade von Wind und K√§lte", hu: "A Sz√©l √©s Hideg Ballad√°ja", fr: "Ballade du Vent", tr: "R√ºzgarƒ±n Baladƒ±", ru: "–ë–∞–ª–ª–∞–¥–∞ –æ –í–µ—Ç—Ä–µ", ar: "ÿ£ÿ∫ŸÜŸäÿ© ÿßŸÑÿ±Ÿäÿ≠" },
            { id: "album_12", kepFajlNev: "album_12.jpg", en: "Infernal Power", de: "H√∂llenmacht", hu: "Pokoli Er≈ë", fr: "Puissance Infernale", tr: "Cehennem G√ºc√º", ru: "–ê–¥—Å–∫–∞—è —Å–∏–ª–∞", ar: "ŸÇŸàÿ© ÿ¨ŸáŸÜŸÖŸäÿ©" },
            { id: "album_13", kepFajlNev: "album_13.jpg", en: "Prerogative of the Flame", de: "Vorrecht der Flamme", hu: "A L√°ng El≈ëjoga", fr: "Pr√©rogative de la Flamme", tr: "Alevin Ayrƒ±calƒ±ƒüƒ±", ru: "–ü—Ä–µ—Ä–æ–≥–∞—Ç–∏–≤–∞ –ü–ª–∞–º–µ–Ω–∏", ar: "ÿßŸÖÿ™Ÿäÿßÿ≤ ÿßŸÑŸÑŸáÿ®" },
            { id: "album_14", kepFajlNev: "album_14.jpg", en: "Frostdragon Empire", de: "Frostdrachen-Imperium", hu: "Fagys√°rk√°ny Birodalom", fr: "Empire du Dragon de Givre", tr: "Buz Ejderhasƒ± ƒ∞mparatorluƒüu", ru: "–ò–º–ø–µ—Ä–∏—è –õ–µ–¥—è–Ω–æ–≥–æ –î—Ä–∞–∫–æ–Ω–∞", ar: "ÿ•ŸÖÿ®ÿ±ÿßÿ∑Ÿàÿ±Ÿäÿ© ÿ™ŸÜŸäŸÜ ÿßŸÑÿµŸÇŸäÿπ" },
            { id: "album_15", kepFajlNev: "album_15.jpg", en: "Kings of Combat", de: "K√∂nige des Kampfes", hu: "A Harc Kir√°lyai", fr: "Rois du Combat", tr: "Sava≈ü Krallarƒ±", ru: "–ö–æ—Ä–æ–ª–∏ –ë–∏—Ç–≤—ã", ar: "ŸÖŸÑŸàŸÉ ÿßŸÑŸÇÿ™ÿßŸÑ" }
        ];

        const gameData = albumAdatok.map((album) => {
            return {
                id: album.id,
                image: `images/${album.kepFajlNev}`, 
                names: { en: album.en, hu: album.hu, de: album.de, fr: album.fr, tr: album.tr, ru: album.ru, ar: album.ar },
                cards: Array.from({length: 9}, (_, cIdx) => ({ 
                    id: `${album.id}_card_${cIdx+1}`, 
                    name: `Card ${cIdx+1}`,
                    pieceCount: 15 // Ezt majd k√°rty√°nk√©nt m√≥dos√≠tjuk a v√©g√©n!
                }))
            };
        });

        const authScreen = document.getElementById('auth-screen');
        const profileScreen = document.getElementById('profile-setup-screen');
        const mainScreen = document.getElementById('main-app-screen');

        function showScreen(screen) {
            authScreen.style.display = 'none'; profileScreen.style.display = 'none'; mainScreen.style.display = 'none';
            screen.style.display = 'block';
        }

        document.getElementById('email-register-btn').addEventListener('click', () => createUserWithEmailAndPassword(auth, document.getElementById('email-input').value, document.getElementById('password-input').value).catch(e => document.getElementById('auth-error').textContent = e.message));
        document.getElementById('email-login-btn').addEventListener('click', () => signInWithEmailAndPassword(auth, document.getElementById('email-input').value, document.getElementById('password-input').value).catch(e => document.getElementById('auth-error').textContent = "Incorrect login details."));
        document.getElementById('google-login-btn').addEventListener('click', () => signInWithPopup(auth, provider).catch(e => console.error(e)));
        document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));

        document.getElementById('save-profile-btn').addEventListener('click', async () => {
            const pName = document.getElementById('player-name').value.trim();
            const pServer = document.getElementById('server-number').value.trim();
            const pAlliance = document.getElementById('alliance-name').value.trim().toUpperCase();
            if(!pName || !pServer || !pAlliance) return document.getElementById('profile-error').textContent = "Please fill all fields!";
            if(pServer.length !== 4 || isNaN(pServer)) return document.getElementById('profile-error').textContent = "State must be 4 digits.";
            if(pAlliance.length !== 3) return document.getElementById('profile-error').textContent = "Alliance must be 3 characters.";
            await setDoc(doc(db, "jatekosok", currentUserUid), { jatekNev: pName, szerver: pServer, szovetseg: pAlliance, inventory: {} });
            checkUserProfile(currentUserUid);
        });

        async function checkUserProfile(uid) {
            const docSnap = await getDoc(doc(db, "jatekosok", uid));
            if (docSnap.exists() && docSnap.data().szerver) {
                const data = docSnap.data();
                document.getElementById('display-name').textContent = data.jatekNev || data.nev;
                document.getElementById('display-server').textContent = data.szerver;
                document.getElementById('display-alliance').textContent = data.szovetseg;
                userInventory = data.inventory || {}; 
                window.renderAlbums(); 
                showScreen(mainScreen);
            } else { showScreen(profileScreen); }
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) { currentUserUid = user.uid; checkUserProfile(user.uid); } 
            else { currentUserUid = null; showScreen(authScreen); }
        });

        const viewAlbums = document.getElementById('view-albums');
        const viewCards = document.getElementById('view-cards');
        const viewPuzzle = document.getElementById('view-puzzle');
        function hideAllViews() { viewAlbums.style.display = 'none'; viewCards.style.display = 'none'; viewPuzzle.style.display = 'none'; document.getElementById('view-matchmaker').style.display='none'; document.getElementById('view-search-results').style.display='none'; }

        window.renderAlbums = function() {
            hideAllViews();
            currentAlbumGlobal = null; currentCardGlobal = null;
            viewAlbums.innerHTML = '';
            
            gameData.forEach(album => {
                const aName = album.names[currLang] || album.names['en'];
                let completedCards = 0;
                album.cards.forEach(card => {
                    let isComplete = true;
                    for(let p = 1; p <= card.pieceCount; p++) {
                        const pid = `${card.id}_piece_${p}`;
                        if(!userInventory[pid] || userInventory[pid] === 0) { isComplete = false; break; }
                    }
                    if(isComplete) completedCards++;
                });
                
                const progressPct = Math.round((completedCards / album.cards.length) * 100);

                const btn = document.createElement('div');
                btn.className = 'list-item';
                btn.onclick = () => window.renderCards(album);
                
                btn.innerHTML = `
                    <div class="album-row">
                        <img src="${album.image}" class="album-img" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2260%22 height=%2260%22%3E%3Crect width=%2260%22 height=%2260%22 fill=%22%23555%22/%3E%3Ctext x=%2230%22 y=%2235%22 font-family=%22Arial%22 font-size=%2220%22 fill=%22%23fff%22 text-anchor=%22middle%22%3E?%3C/text%3E%3C/svg%3E'">
                        <div class="album-info">
                            <div class="album-name">${aName}</div>
                            <div class="progress-bg">
                                <div class="progress-bar" style="width: ${progressPct}%"></div>
                            </div>
                            <div class="progress-text">${completedCards} / ${album.cards.length}</div>
                        </div>
                    </div>
                `;
                viewAlbums.appendChild(btn);
            });
            viewAlbums.style.display = 'block';
        };

        window.renderCards = function(album) {
            hideAllViews();
            currentAlbumGlobal = album;
            viewCards.innerHTML = '';
            const aName = album.names[currLang] || album.names['en'];

            viewCards.innerHTML += `<button class="btn btn-back" onclick="window.renderAlbums()">${i18n[currLang].backAlbum}</button>
                                    <h3 style="text-align:left; margin-top:0;">üìñ ${aName}</h3>
                                    <p style="text-align:right; font-size:12px; color:#aaa; margin-bottom:5px;">${i18n[currLang].cardsOwnedInfo} ‚¨á</p>`;
            
            album.cards.forEach(card => {
                let isComplete = true;
                for(let p = 1; p <= card.pieceCount; p++) {
                    const pid = `${card.id}_piece_${p}`;
                    if(!userInventory[pid] || userInventory[pid] === 0) { isComplete = false; break; }
                }

                const row = document.createElement('div');
                row.className = 'list-item card-item';
                row.innerHTML = `<span style="flex-grow:1; text-align:left;">${card.name}</span>`;
                row.onclick = () => window.renderPuzzle(album, card);
                
                const fastFillBtn = document.createElement('div');
                fastFillBtn.className = `check-btn ${isComplete ? 'checked' : 'unchecked'}`;
                fastFillBtn.innerHTML = '‚úî';
                
                // Kapcsol√≥ (Toggle) m≈±k√∂d√©s!
                fastFillBtn.onclick = (e) => {
                    e.stopPropagation(); 
                    if(isComplete) {
                        for(let p = 1; p <= card.pieceCount; p++) {
                            const pid = `${card.id}_piece_${p}`;
                            userInventory[pid] = 0;
                        }
                    } else {
                        for(let p = 1; p <= card.pieceCount; p++) {
                            const pid = `${card.id}_piece_${p}`;
                            if(!userInventory[pid] || userInventory[pid] === 0) userInventory[pid] = 1;
                        }
                    }
                    window.renderCards(album); 
                };
                
                row.appendChild(fastFillBtn);
                viewCards.appendChild(row);
            });
            viewCards.style.display = 'block';
        };

        window.renderPuzzle = function(album, card) {
            hideAllViews();
            currentAlbumGlobal = album; currentCardGlobal = card;
            viewPuzzle.innerHTML = '';
            const aName = album.names[currLang] || album.names['en'];

            viewPuzzle.innerHTML += `<div style="display:flex; justify-content:space-between;">
                                        <button class="btn btn-back" onclick="window.renderCards(currentAlbumGlobal)" style="margin:0;">${i18n[currLang].backCard}</button>
                                        <button class="btn btn-green btn-small" style="margin:0;" onclick="window.fillCurrentCard()">${i18n[currLang].markDone}</button>
                                     </div>
                                     <h3 style="text-align:left;"><small style="color:#e09f3e;">${aName}</small><br>${card.name}</h3>`;
            
            const grid = document.createElement('div');
            grid.className = 'puzzle-grid';

            for(let p = 1; p <= card.pieceCount; p++) {
                const pieceId = `${card.id}_piece_${p}`;
                const currentQty = userInventory[pieceId] || 0; 
                let displayQty = currentQty;
                let bgClass = '';
                if (currentQty === 0) { displayQty = "0"; bgClass = 'piece-missing'; }
                else if (currentQty === 1) { displayQty = "‚úî"; }
                else { displayQty = `+${currentQty - 1}`; bgClass = 'piece-surplus'; }
                
                const pieceDiv = document.createElement('div');
                pieceDiv.className = `puzzle-piece ${bgClass}`;
                pieceDiv.id = `box-${pieceId}`;
                pieceDiv.tabIndex = 0; 
                
                pieceDiv.onkeydown = (e) => {
                    if (e.key === 'ArrowUp') { window.updateQty(pieceId, 1); e.preventDefault(); }
                    if (e.key === 'ArrowDown') { window.updateQty(pieceId, -1); e.preventDefault(); }
                    if (e.key === 'ArrowRight') { if(pieceDiv.nextElementSibling) pieceDiv.nextElementSibling.focus(); e.preventDefault(); }
                    if (e.key === 'ArrowLeft') { if(pieceDiv.previousElementSibling) pieceDiv.previousElementSibling.focus(); e.preventDefault(); }
                };
                
                pieceDiv.innerHTML = `
                    <div class="piece-shape">${p}</div>
                    <div class="controls">
                        <button tabindex="-1" class="qty-btn minus" onclick="window.updateQty('${pieceId}', -1); document.getElementById('box-${pieceId}').focus();">-</button>
                        <span class="qty-display" id="qty-${pieceId}">${displayQty}</span>
                        <button tabindex="-1" class="qty-btn plus" onclick="window.updateQty('${pieceId}', 1); document.getElementById('box-${pieceId}').focus();">+</button>
                    </div>
                `;
                grid.appendChild(pieceDiv);
            }
            viewPuzzle.appendChild(grid);
            viewPuzzle.style.display = 'block';
        };

        window.fillCurrentCard = function() {
            for(let p = 1; p <= currentCardGlobal.pieceCount; p++) {
                const pid = `${currentCardGlobal.id}_piece_${p}`;
                if(!userInventory[pid] || userInventory[pid] === 0) userInventory[pid] = 1; 
            }
            window.renderPuzzle(currentAlbumGlobal, currentCardGlobal); 
        };

        window.updateQty = function(pieceId, change) {
            let currentQty = userInventory[pieceId] || 0;
            currentQty += change;
            if (currentQty < 0) currentQty = 0; 
            userInventory[pieceId] = currentQty; 
            
            let displayQty = currentQty;
            const pieceBox = document.getElementById(`box-${pieceId}`);
            pieceBox.classList.remove('piece-missing', 'piece-surplus');
            if(currentQty === 0) { displayQty = "0"; pieceBox.classList.add('piece-missing'); } 
            else if(currentQty === 1) { displayQty = "‚úî"; } 
            else { displayQty = `+${currentQty - 1}`; pieceBox.classList.add('piece-surplus'); }
            document.getElementById(`qty-${pieceId}`).textContent = displayQty;
        };

        document.getElementById('save-inventory-btn').addEventListener('click', async () => {
            const toast = document.getElementById('toast-msg');
            try {
                await updateDoc(doc(db, "jatekosok", currentUserUid), { inventory: userInventory });
                toast.textContent = "‚úÖ Saved!";
                toast.classList.add("show");
                setTimeout(() => toast.classList.remove("show"), 2000);
            } catch (error) { console.error(error); }
        });

        // MATCHMAKER LOGIKA (CSERE MOTOR)
        window.runMatchmaker = async function(scope) {
            hideAllViews();
            const viewMatchmaker = document.getElementById('view-matchmaker');
            viewMatchmaker.innerHTML = '<h3>‚è≥...</h3>';
            viewMatchmaker.style.display = 'block';

            const backBtn = document.createElement('button');
            backBtn.className = 'btn btn-back';
            backBtn.textContent = i18n[currLang].backAlbum;
            backBtn.onclick = () => window.renderAlbums();

            try {
                const myServer = document.getElementById('display-server').textContent;
                const myAlliance = document.getElementById('display-alliance').textContent;

                let q = (scope === 'alliance') 
                    ? query(collection(db, "jatekosok"), where("szerver", "==", myServer), where("szovetseg", "==", myAlliance))
                    : query(collection(db, "jatekosok"), where("szerver", "==", myServer));
                
                const querySnapshot = await getDocs(q);

                let resultsHtml = '';
                let hasMatches = false;

                querySnapshot.forEach((userDoc) => {
                    if (userDoc.id === currentUserUid) return; 

                    const otherData = userDoc.data();
                    const otherInv = otherData.inventory || {};
                    const otherName = `${otherData.jatekNev || otherData.nev} [${otherData.szovetseg}]`; 

                    let giveToMe = []; 
                    let takeFromMe = []; 

                    gameData.forEach(album => {
                        const aName = album.names[currLang] || album.names['en'];
                        album.cards.forEach(card => {
                            for(let p = 1; p <= card.pieceCount; p++) {
                                const pieceId = `${card.id}_piece_${p}`;
                                const myQty = userInventory[pieceId] || 0;
                                const otherQty = otherInv[pieceId] || 0;
                                const pieceName = `<b>${aName}</b><br>${card.name} / ${p}.`;

                                if (myQty === 0 && otherQty >= 2) {
                                    giveToMe.push(`<div class="trade-row"><span>üü¢ ${pieceName}</span><button class="btn btn-green btn-small" onclick="window.executeTrade('${userDoc.id}', '${pieceId}', 'receive', this)">${i18n[currLang].traded}</button></div>`);
                                }
                                if (myQty >= 2 && otherQty === 0) {
                                    takeFromMe.push(`<div class="trade-row"><span>üîµ ${pieceName}</span><button class="btn btn-blue btn-small" onclick="window.executeTrade('${userDoc.id}', '${pieceId}', 'give', this)">${i18n[currLang].traded}</button></div>`);
                                }
                            }
                        });
                    });

                    if (giveToMe.length > 0 || takeFromMe.length > 0) {
                        hasMatches = true;
                        resultsHtml += `<div class="match-card"><h4>üë§ ${otherName}</h4>`;
                        if (giveToMe.length > 0) resultsHtml += `<div class="match-detail" style="border-left: 3px solid #28a745;"><b style="color:#28a745;">${i18n[currLang].givesYou}</b><br>${giveToMe.join('')}</div>`;
                        if (takeFromMe.length > 0) resultsHtml += `<div class="match-detail" style="border-left: 3px solid #4285F4;"><b style="color:#4285F4;">${i18n[currLang].asksFrom}</b><br>${takeFromMe.join('')}</div>`;
                        resultsHtml += `</div>`;
                    }
                });

                viewMatchmaker.innerHTML = '';
                viewMatchmaker.appendChild(backBtn);
                viewMatchmaker.insertAdjacentHTML('beforeend', `<h3>ü§ù ${scope === 'alliance' ? myAlliance : myServer}</h3>`);

                if (hasMatches) viewMatchmaker.insertAdjacentHTML('beforeend', resultsHtml);
                else viewMatchmaker.insertAdjacentHTML('beforeend', `<p>${i18n[currLang].noMatch}</p>`);

            } catch (error) { viewMatchmaker.innerHTML = '<h3>‚ùå Error</h3>'; viewMatchmaker.appendChild(backBtn); }
        };

        window.executeTrade = async function(otherUid, pieceId, type, btnElement) {
            if(!confirm("Are you sure? This updates both inventories!")) return;
            btnElement.disabled = true;
            btnElement.textContent = "‚è≥...";

            try {
                let myChange = (type === 'give') ? -1 : 1;
                let otherChange = (type === 'give') ? 1 : -1;
                await updateDoc(doc(db, "jatekosok", currentUserUid), { [`inventory.${pieceId}`]: increment(myChange) });
                await updateDoc(doc(db, "jatekosok", otherUid), { [`inventory.${pieceId}`]: increment(otherChange) });
                userInventory[pieceId] = (userInventory[pieceId] || 0) + myChange;
                btnElement.textContent = "‚úÖ";
                btnElement.style.backgroundColor = "#555";
            } catch(error) { alert("Trade error!"); btnElement.disabled = false; btnElement.textContent = i18n[currLang].traded; }
        };
    </script>
</body>
</html>