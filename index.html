<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Whiteout Survival - Tundra Trade</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; text-align: center; margin: 0; padding: 20px; background: linear-gradient(135deg, #0f2027, #203a43, #2c5364); color: #eef2f5; min-height: 100vh; }
        .container { background: rgba(25, 35, 50, 0.6); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); max-width: 800px; margin: auto; padding: 30px; border-radius: 15px; box-shadow: 0 8px 32px rgba(0,0,0,0.5); }
        h2, h3 { color: #ffffff; text-shadow: 1px 1px 3px rgba(0,0,0,0.5); }
        input, select { width: 90%; padding: 12px; margin: 10px 0; background: rgba(255, 255, 255, 0.9); border: 2px solid transparent; border-radius: 8px; box-sizing: border-box; font-size: 16px; color: #333; transition: all 0.3s; }
        input:focus { border-color: #4285F4; outline: none; box-shadow: 0 0 10px rgba(66, 133, 244, 0.5); }
        
        .btn { padding: 12px 20px; margin: 5px 0; font-size: 16px; cursor: pointer; color: white; border: none; border-radius: 8px; font-weight: bold; width: 90%; text-transform: uppercase; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        .btn:active { transform: scale(0.97); }
        .btn-blue { background: linear-gradient(90deg, #4285F4, #357ae8); } 
        .btn-green { background: linear-gradient(90deg, #28a745, #218838); } 
        .btn-dark { background: linear-gradient(90deg, #333, #555); } 
        .btn-red { background: linear-gradient(90deg, #d9534f, #c9302c); } 
        .btn-back { background-color: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); width: auto; padding: 8px 15px; margin-bottom: 15px; text-transform: none;}
        .btn-small { padding: 6px 12px; font-size: 14px; margin-left: 10px; width: auto; box-shadow: none;}
        
        .list-item { background: rgba(0, 0, 0, 0.4); border: 1px solid rgba(255,255,255,0.05); color: white; padding: 15px; border-radius: 10px; margin: 10px auto; cursor: pointer; width: 90%; transition: transform 0.1s, background 0.2s; text-align: left; }
        .list-item:hover { background: rgba(0, 0, 0, 0.6); }
        .list-item:active { transform: scale(0.98); }
        .card-item { background: rgba(224, 159, 62, 0.2); border-left: 4px solid #e09f3e; display: flex; justify-content: space-between; align-items: center; font-weight: bold; font-size: 18px;}
        
        /* √öJ: Album lista diz√°jn k√©phez √©s cs√≠khoz */
        .album-row { display: flex; align-items: center; justify-content: flex-start; width: 100%; }
        .album-img { width: 60px; height: 60px; border-radius: 8px; object-fit: cover; margin-right: 15px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); }
        .album-info { flex-grow: 1; display: flex; flex-direction: column; justify-content: center; }
        .album-name { font-size: 18px; font-weight: bold; margin-bottom: 5px; }
        .progress-bg { width: 100%; height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; overflow: hidden; }
        .progress-bar { height: 100%; background: #28a745; width: 0%; transition: width 0.3s ease; }
        .progress-text { font-size: 12px; color: #aaa; text-align: right; margin-top: 2px;}

        #top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.1);}
        #lang-selector { width: auto; padding: 8px; margin: 0; font-size: 14px; background: rgba(255,255,255,0.9); color: #000; border-radius: 5px;}
        .action-buttons { display: flex; justify-content: center; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;}
        #search-bar { position: sticky; top: 0; background: rgba(25, 35, 50, 0.95); padding: 10px 0; z-index: 10; border-radius: 10px; margin-bottom: 15px; backdrop-filter: blur(5px);}
        
        .puzzle-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(110px, 1fr)); gap: 12px; margin-top: 15px; }
        .puzzle-piece { border-radius: 10px; padding: 8px; background: linear-gradient(135deg, #4b6cb7, #182848); display: flex; flex-direction: column; align-items: center; justify-content: space-between; min-height: 110px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); outline: none; transition: transform 0.1s; }
        .puzzle-piece:focus { border: 2px solid #ffc107; transform: scale(1.05); }
        .piece-shape { width: 45px; height: 45px; background: rgba(255,255,255,0.15); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 18px; margin-bottom: 8px; border: 1px solid rgba(255,255,255,0.2);}
        .controls { display: flex; align-items: center; justify-content: space-between; width: 100%; background: rgba(0,0,0,0.4); border-radius: 6px; overflow: hidden; padding: 2px;}
        .qty-btn { background: transparent; border: none; padding: 5px 10px; cursor: pointer; font-weight: bold; font-size: 16px; color: white; transition: background 0.2s;}
        .qty-btn:hover { background: rgba(255,255,255,0.2); }
        .qty-display { font-weight: bold; color: #fff; font-size: 16px;}
        .piece-missing { background: linear-gradient(135deg, #4a5568, #2d3748); opacity: 0.8;}
        .piece-surplus { background: linear-gradient(135deg, #2b5876, #4e4376); }
        
        .check-btn { width: 32px; height: 32px; border-radius: 6px; border: 2px solid rgba(255,255,255,0.5); display: flex; align-items: center; justify-content: center; font-size: 18px; cursor: pointer; transition: all 0.2s; background: rgba(0,0,0,0.2); }
        .check-btn.checked { background-color: #28a745; border-color: #28a745; color: white; box-shadow: 0 0 10px rgba(40,167,69,0.5);}
        .check-btn.unchecked { color: transparent; }
        .check-btn.unchecked:hover { background-color: rgba(255,255,255,0.1); border-color: white;}

        #toast-msg { visibility: hidden; min-width: 250px; background-color: rgba(40, 167, 69, 0.95); color: #fff; text-align: center; border-radius: 8px; padding: 15px; position: fixed; z-index: 1000; left: 50%; top: 50%; transform: translate(-50%, -50%); font-size: 18px; font-weight: bold; box-shadow: 0 4px 15px rgba(0,0,0,0.5); opacity: 0; transition: opacity 0.3s, visibility 0.3s; pointer-events: none; backdrop-filter: blur(5px); }
        #toast-msg.show { visibility: visible; opacity: 1; }
        hr { border: 0; border-top: 1px solid rgba(255,255,255,0.1); margin: 25px 0;}
    </style>
</head>
<body>

    <div id="toast-msg">‚úÖ Saved!</div>

    <div id="auth-screen" class="container">
        <div style="margin-bottom: 30px;">
            <h1 style="color: #e09f3e; font-size: 32px; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 2px;">Whiteout Survival</h1>
            <h2 style="color: #fff; margin-top: 0; font-weight: normal; font-size: 22px;">‚ùÑÔ∏è Tundra Trade ‚ùÑÔ∏è</h2>
            <p style="color: #aaa; font-style: italic;">The Ultimate Puzzle Exchange Tool</p>
        </div>
        <input type="email" id="email-input" placeholder="Email address">
        <input type="password" id="password-input" placeholder="Password">
        <div id="auth-error" style="color:#ff6b6b; margin-bottom:10px; font-weight:bold;"></div>
        <button id="email-login-btn" class="btn btn-green">Login with Email</button>
        <button id="email-register-btn" class="btn btn-dark">Register new account</button>
        <div style="margin: 20px 0; color: #888; display: flex; align-items: center; justify-content: center;">
            <hr style="flex-grow: 1; margin: 0 15px;"><span style="font-size: 14px;">OR</span><hr style="flex-grow: 1; margin: 0 15px;">
        </div>
        <button id="google-login-btn" class="btn btn-blue">Login with Google</button>
    </div>

    <div id="profile-setup-screen" class="container" style="display: none;">
        <h2 style="color: #e09f3e;">Setup your profile</h2>
        <input type="text" id="player-name" placeholder="Player Name (any characters)">
        <input type="number" id="server-number" placeholder="State/Server (exactly 4 digits, e.g., 2530)">
        <input type="text" id="alliance-name" placeholder="Alliance Tag (exactly 3 chars, e.g., ABC)">
        <div id="profile-error" style="color:#ff6b6b; margin-bottom:10px; font-weight:bold;"></div>
        <button id="save-profile-btn" class="btn btn-green">Save & Continue</button>
    </div>

    <div id="main-app-screen" class="container" style="display: none;">
        <div id="top-bar">
            <div style="text-align: left;">
                <h3 style="margin: 0; color:#e09f3e;" id="display-name"></h3>
                <small style="color: #ccc;"><span class="t-state">State</span>: <b id="display-server" style="color:#fff;"></b> | <span class="t-alliance">Alliance</span>: <b id="display-alliance" style="color:#fff;"></b></small>
            </div>
            <div>
                <select id="lang-selector" onchange="changeLanguage(this.value)">
                    <option value="en" selected>üá¨üáß English</option>
                    <option value="hu">üá≠üá∫ Magyar</option>
                    <option value="de">üá©üá™ Deutsch</option>
                </select>
            </div>
        </div>
        
        <div class="action-buttons">
            <button onclick="runMatchmaker('alliance')" class="btn btn-blue t-btn-clan" style="width: 48%; box-shadow: 0 4px 15px rgba(66, 133, 244, 0.4);">ü§ù Search in Clan</button>
            <button onclick="runMatchmaker('state')" class="btn btn-dark t-btn-state" style="width: 48%;">üåç Search in State</button>
        </div>

        <div id="search-bar">
            <input type="text" id="search-input" class="t-search-ph" placeholder="üîç Search album or card...">
        </div>

        <div id="view-albums"></div>
        <div id="view-cards" style="display: none;"></div>
        <div id="view-puzzle" style="display: none;"></div>
        <div id="view-search-results" style="display: none;"></div>
        <div id="view-matchmaker" style="display: none;"></div>

        <br><hr>
        <button id="save-inventory-btn" class="btn btn-green t-btn-save" style="font-size: 18px; padding: 15px; box-shadow: 0 4px 15px rgba(40, 167, 69, 0.4);">üíæ Save Changes</button>
        <br><br>
        <button id="logout-btn" class="btn btn-back t-btn-logout" style="width: auto; background: transparent;">Logout</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, query, where, getDocs, increment } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDeEK5nOuvuELtGd61Q7W04uKGcJqG1L1U",
  authDomain: "tundra-album.firebaseapp.com",
  projectId: "tundra-album",
  storageBucket: "tundra-album.firebasestorage.app",
  messagingSenderId: "469371801375",
  appId: "1:469371801375:web:71007b232a98fe8bdbea2a",
  measurementId: "G-2LQT9X23X5"
};

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        let currentUserUid = null;
        let userInventory = {}; 
        let currentAlbumGlobal = null;
        let currentCardGlobal = null;

        const i18n = {
            en: { state: "State", alliance: "Alliance", btnClan: "ü§ù Search in Clan", btnState: "üåç Search in State", searchPh: "üîç Search album or card...", btnSave: "üíæ Save Changes", btnLogout: "Logout", backAlbum: "‚¨Ö Back to Albums", backCard: "‚¨Ö Back to Cards", markDone: "‚úî Set missing to 1", cardsOwnedInfo: "Completed Cards" },
            hu: { state: "√Ållam", alliance: "Sz√∂vets√©g", btnClan: "ü§ù Keres√©s Kl√°nban", btnState: "üåç Keres√©s √Ållamban", searchPh: "üîç Keres√©s albumra vagy k√°rty√°ra...", btnSave: "üíæ V√°ltoz√°sok Ment√©se", btnLogout: "Kijelentkez√©s", backAlbum: "‚¨Ö Vissza az Albumokhoz", backCard: "‚¨Ö Vissza a K√°rty√°khoz", markDone: "‚úî Hi√°nyz√≥k 1-re √°ll√≠t√°sa", cardsOwnedInfo: "Befejezett k√°rty√°k" },
            de: { state: "Staat", alliance: "Allianz", btnClan: "ü§ù Suche im Clan", btnState: "üåç Suche im Staat", searchPh: "üîç Album oder Karte suchen...", btnSave: "üíæ Speichern", btnLogout: "Abmelden", backAlbum: "‚¨Ö Zur√ºck", backCard: "‚¨Ö Zur√ºck", markDone: "‚úî Fehlende auf 1", cardsOwnedInfo: "Komplette Karten" }
        };
        let currLang = 'en';

        window.changeLanguage = function(lang) {
            currLang = lang;
            document.querySelector('.t-state').textContent = i18n[lang].state;
            document.querySelector('.t-alliance').textContent = i18n[lang].alliance;
            document.querySelector('.t-btn-clan').textContent = i18n[lang].btnClan;
            document.querySelector('.t-btn-state').textContent = i18n[lang].btnState;
            document.querySelector('.t-search-ph').placeholder = i18n[lang].searchPh;
            document.querySelector('.t-btn-save').textContent = i18n[lang].btnSave;
            document.querySelector('.t-btn-logout').textContent = i18n[lang].btnLogout;
            
            if(document.getElementById('view-albums').style.display === 'block') renderAlbums();
            if(document.getElementById('view-cards').style.display === 'block') renderCards(currentAlbumGlobal);
            if(document.getElementById('view-puzzle').style.display === 'block') renderPuzzle(currentAlbumGlobal, currentCardGlobal);
        };

        const albumTranslations = [
            { en: "Rekindled Flames", de: "Wiederentfachte Flammen", hu: "√öjra√©led≈ë L√°ngok" },
            { en: "Explore the World", de: "Erkunde die Welt", hu: "Fedezd fel a Vil√°got" },
            { en: "Daybreak Island", de: "Insel des Tagesanbruchs", hu: "Hajnal Sziget" }
            // A t√∂bbi albumot ide tudod majd be√≠rni
        ];

        // --- √öJ LOGIKA: A k√°rty√°knak megmondjuk, h√°ny darabb√≥l √°llnak (pieceCount) ---
        const gameData = albumTranslations.map((namesObj, aIdx) => {
            return {
                id: `album_${aIdx}`,
                image: `images/album_${aIdx}.jpg`, // Automatikusan keresi az images/ mapp√°ban!
                names: namesObj,
                cards: Array.from({length: 9}, (_, cIdx) => ({ 
                    id: `album_${aIdx}_card_${cIdx+1}`, 
                    name: `Card ${cIdx+1}`,
                    pieceCount: 15 // Ezt majd k√©s≈ëbb k√°rty√°nk√©nt √°t√≠rhatjuk 12-re, 18-ra!
                }))
            };
        });

        const authScreen = document.getElementById('auth-screen');
        const profileScreen = document.getElementById('profile-setup-screen');
        const mainScreen = document.getElementById('main-app-screen');

        function showScreen(screen) {
            authScreen.style.display = 'none'; profileScreen.style.display = 'none'; mainScreen.style.display = 'none';
            screen.style.display = 'block';
        }

        // --- Auth Logik√°k (r√∂vid√≠tve a minta kedv√©√©rt) ---
        onAuthStateChanged(auth, async (user) => {
            if (user) { 
                currentUserUid = user.uid; 
                const docSnap = await getDoc(doc(db, "jatekosok", user.uid));
                if (docSnap.exists() && docSnap.data().szerver) {
                    const data = docSnap.data();
                    document.getElementById('display-name').textContent = data.jatekNev || data.nev;
                    document.getElementById('display-server').textContent = data.szerver;
                    document.getElementById('display-alliance').textContent = data.szovetseg;
                    userInventory = data.inventory || {}; 
                    renderAlbums(); 
                    showScreen(mainScreen);
                } else { showScreen(profileScreen); }
            } else { currentUserUid = null; showScreen(authScreen); }
        });

        const viewAlbums = document.getElementById('view-albums');
        const viewCards = document.getElementById('view-cards');
        const viewPuzzle = document.getElementById('view-puzzle');
        function hideAllViews() { viewAlbums.style.display = 'none'; viewCards.style.display = 'none'; viewPuzzle.style.display = 'none'; document.getElementById('view-matchmaker').style.display='none'; document.getElementById('view-search-results').style.display='none'; }

        // --- ALBUMOK RENDEREL√âSE FOLYAMATJELZ≈êVEL ---
        function renderAlbums() {
            hideAllViews();
            currentAlbumGlobal = null; currentCardGlobal = null;
            viewAlbums.innerHTML = '';
            
            gameData.forEach(album => {
                const aName = album.names[currLang] || album.names['en'];
                
                // Kisz√°moljuk a z√∂ld cs√≠kot!
                let completedCards = 0;
                album.cards.forEach(card => {
                    let isComplete = true;
                    // Itt m√°r a card.pieceCount-ot (15, 12, stb.) haszn√°ljuk!
                    for(let p = 1; p <= card.pieceCount; p++) {
                        const pid = `${card.id}_piece_${p}`;
                        if(!userInventory[pid] || userInventory[pid] === 0) {
                            isComplete = false; break;
                        }
                    }
                    if(isComplete) completedCards++;
                });
                
                const progressPct = Math.round((completedCards / album.cards.length) * 100);

                const btn = document.createElement('div');
                btn.className = 'list-item';
                btn.onclick = () => renderCards(album);
                
                // √öj strukt√∫ra: K√©p balra, n√©v √©s cs√≠k jobbra
                btn.innerHTML = `
                    <div class="album-row">
                        <img src="${album.image}" class="album-img" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2260%22 height=%2260%22%3E%3Crect width=%2260%22 height=%2260%22 fill=%22%23555%22/%3E%3Ctext x=%2230%22 y=%2235%22 font-family=%22Arial%22 font-size=%2220%22 fill=%22%23fff%22 text-anchor=%22middle%22%3E?%3C/text%3E%3C/svg%3E'">
                        <div class="album-info">
                            <div class="album-name">${aName}</div>
                            <div class="progress-bg">
                                <div class="progress-bar" style="width: ${progressPct}%"></div>
                            </div>
                            <div class="progress-text">${completedCards} / ${album.cards.length}</div>
                        </div>
                    </div>
                `;
                viewAlbums.appendChild(btn);
            });
            viewAlbums.style.display = 'block';
        }

        function renderCards(album) {
            hideAllViews();
            currentAlbumGlobal = album;
            viewCards.innerHTML = '';
            const aName = album.names[currLang] || album.names['en'];

            viewCards.innerHTML += `<button class="btn btn-back" onclick="renderAlbums()">${i18n[currLang].backAlbum}</button>
                                    <h3 style="text-align:left; margin-top:0;">üìñ ${aName}</h3>
                                    <p style="text-align:right; font-size:12px; color:#aaa; margin-bottom:5px;">${i18n[currLang].cardsOwnedInfo} ‚¨á</p>`;
            
            album.cards.forEach(card => {
                let isComplete = true;
                // Itt is a card.pieceCount!
                for(let p = 1; p <= card.pieceCount; p++) {
                    const pid = `${card.id}_piece_${p}`;
                    if(!userInventory[pid] || userInventory[pid] === 0) { isComplete = false; break; }
                }

                const row = document.createElement('div');
                row.className = 'list-item card-item';
                row.innerHTML = `<span style="flex-grow:1; text-align:left;">${card.name}</span>`;
                row.onclick = () => renderPuzzle(album, card);
                
                const fastFillBtn = document.createElement('div');
                fastFillBtn.className = `check-btn ${isComplete ? 'checked' : 'unchecked'}`;
                fastFillBtn.innerHTML = '‚úî';
                fastFillBtn.onclick = (e) => {
                    e.stopPropagation(); 
                    if(isComplete) return; 
                    for(let p = 1; p <= card.pieceCount; p++) {
                        const pid = `${card.id}_piece_${p}`;
                        if(!userInventory[pid] || userInventory[pid] === 0) userInventory[pid] = 1;
                    }
                    renderCards(album); 
                };
                
                row.appendChild(fastFillBtn);
                viewCards.appendChild(row);
            });
            viewCards.style.display = 'block';
        }

        window.renderPuzzle = function(album, card) {
            hideAllViews();
            currentAlbumGlobal = album; currentCardGlobal = card;
            viewPuzzle.innerHTML = '';
            const aName = album.names[currLang] || album.names['en'];

            viewPuzzle.innerHTML += `<div style="display:flex; justify-content:space-between;">
                                        <button class="btn btn-back" onclick="renderCards(currentAlbumGlobal)" style="margin:0;">${i18n[currLang].backCard}</button>
                                        <button class="btn btn-green btn-small" style="margin:0;" onclick="fillCurrentCard()">${i18n[currLang].markDone}</button>
                                     </div>
                                     <h3 style="text-align:left;"><small style="color:#e09f3e;">${aName}</small><br>${card.name}</h3>`;
            
            const grid = document.createElement('div');
            grid.className = 'puzzle-grid';

            // Itt is a card.pieceCount!
            for(let p = 1; p <= card.pieceCount; p++) {
                const pieceId = `${card.id}_piece_${p}`;
                const currentQty = userInventory[pieceId] || 0; 
                let displayQty = currentQty;
                let bgClass = '';
                if (currentQty === 0) { displayQty = "0"; bgClass = 'piece-missing'; }
                else if (currentQty === 1) { displayQty = "‚úî"; }
                else { displayQty = `+${currentQty - 1}`; bgClass = 'piece-surplus'; }
                
                const pieceDiv = document.createElement('div');
                pieceDiv.className = `puzzle-piece ${bgClass}`;
                pieceDiv.id = `box-${pieceId}`;
                pieceDiv.tabIndex = 0; 
                
                pieceDiv.onkeydown = (e) => {
                    if (e.key === 'ArrowUp') { updateQty(pieceId, 1); e.preventDefault(); }
                    if (e.key === 'ArrowDown') { updateQty(pieceId, -1); e.preventDefault(); }
                    if (e.key === 'ArrowRight') { if(pieceDiv.nextElementSibling) pieceDiv.nextElementSibling.focus(); e.preventDefault(); }
                    if (e.key === 'ArrowLeft') { if(pieceDiv.previousElementSibling) pieceDiv.previousElementSibling.focus(); e.preventDefault(); }
                };
                
                pieceDiv.innerHTML = `
                    <div class="piece-shape">${p}</div>
                    <div class="controls">
                        <button tabindex="-1" class="qty-btn minus" onclick="updateQty('${pieceId}', -1); document.getElementById('box-${pieceId}').focus();">-</button>
                        <span class="qty-display" id="qty-${pieceId}">${displayQty}</span>
                        <button tabindex="-1" class="qty-btn plus" onclick="updateQty('${pieceId}', 1); document.getElementById('box-${pieceId}').focus();">+</button>
                    </div>
                `;
                grid.appendChild(pieceDiv);
            }
            viewPuzzle.appendChild(grid);
            viewPuzzle.style.display = 'block';
        }

        window.fillCurrentCard = function() {
            for(let p = 1; p <= currentCardGlobal.pieceCount; p++) {
                const pid = `${currentCardGlobal.id}_piece_${p}`;
                if(!userInventory[pid] || userInventory[pid] === 0) userInventory[pid] = 1; 
            }
            renderPuzzle(currentAlbumGlobal, currentCardGlobal); 
        };

        window.updateQty = function(pieceId, change) {
            let currentQty = userInventory[pieceId] || 0;
            currentQty += change;
            if (currentQty < 0) currentQty = 0; 
            userInventory[pieceId] = currentQty; 
            
            let displayQty = currentQty;
            const pieceBox = document.getElementById(`box-${pieceId}`);
            pieceBox.classList.remove('piece-missing', 'piece-surplus');
            if(currentQty === 0) { displayQty = "0"; pieceBox.classList.add('piece-missing'); } 
            else if(currentQty === 1) { displayQty = "‚úî"; } 
            else { displayQty = `+${currentQty - 1}`; pieceBox.classList.add('piece-surplus'); }
            document.getElementById(`qty-${pieceId}`).textContent = displayQty;
        };

        document.getElementById('save-inventory-btn').addEventListener('click', async () => {
            const toast = document.getElementById('toast-msg');
            try {
                await updateDoc(doc(db, "jatekosok", currentUserUid), { inventory: userInventory });
                toast.textContent = "‚úÖ Saved!";
                toast.classList.add("show");
                setTimeout(() => toast.classList.remove("show"), 2000);
            } catch (error) { console.error(error); }
        });
    </script>
</body>
</html>