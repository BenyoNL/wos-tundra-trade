
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Whiteout Survival - Tundra Trade</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; text-align: center; margin: 0; padding: 20px; background: linear-gradient(135deg, #0f2027, #203a43, #2c5364); color: #eef2f5; min-height: 100vh; }
        .container { background: rgba(25, 35, 50, 0.6); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); max-width: 800px; margin: auto; padding: 30px; border-radius: 15px; box-shadow: 0 8px 32px rgba(0,0,0,0.5); }
        h2, h3 { color: #ffffff; text-shadow: 1px 1px 3px rgba(0,0,0,0.5); }
        input, select { width: 90%; padding: 12px; margin: 10px 0; background: rgba(255, 255, 255, 0.9); border: 2px solid transparent; border-radius: 8px; box-sizing: border-box; font-size: 16px; color: #333; transition: all 0.3s; }
        input:focus { border-color: #4285F4; outline: none; box-shadow: 0 0 10px rgba(66, 133, 244, 0.5); }
        
        .btn { padding: 12px 20px; margin: 5px 0; font-size: 16px; cursor: pointer; color: white; border: none; border-radius: 8px; font-weight: bold; width: 90%; text-transform: uppercase; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        .btn:active { transform: scale(0.97); }
        .btn-blue { background: linear-gradient(90deg, #4285F4, #357ae8); } 
        .btn-green { background: linear-gradient(90deg, #28a745, #218838); } 
        .btn-dark { background: linear-gradient(90deg, #333, #555); } 
        .btn-red { background: linear-gradient(90deg, #d9534f, #c9302c); } 
        .btn-back { background-color: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); width: auto; padding: 8px 15px; margin-bottom: 15px; text-transform: none;}
        .btn-small { padding: 6px 12px; font-size: 14px; margin-left: 10px; width: auto; box-shadow: none;}
        
        .list-item { background: rgba(0, 0, 0, 0.4); border: 1px solid rgba(255,255,255,0.05); color: white; border-radius: 12px; margin: 15px auto; cursor: pointer; width: 90%; transition: transform 0.1s, background 0.2s; text-align: left; }
        .list-item:hover { background: rgba(0, 0, 0, 0.6); }
        .list-item:active { transform: scale(0.98); }
        
        .album-card { padding: 0; overflow: hidden; display: flex; flex-direction: column; }
        .album-img-large { width: 100%; height: 400px; object-fit: cover; border-bottom: 3px solid #e09f3e; display: block; border-radius: 12px 12px 0 0; }
        .album-info-box { padding: 20px; box-sizing: border-box; width: 100%; }
        .album-title-large { font-size: 24px; font-weight: bold; color: #fff; margin-bottom: 15px; text-align: center; }
        
        /* √öJ K√ÅRTYA R√ÅCS (GRID) DIZ√ÅJN */
        .card-grid-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 15px; }
        .grid-card-item { background: rgba(0,0,0,0.5); border: 2px solid rgba(224, 159, 62, 0.3); border-radius: 8px; padding: 10px; cursor: pointer; position: relative; display: flex; flex-direction: column; justify-content: space-between; transition: all 0.2s; min-height: 140px; }
        .grid-card-item:hover { border-color: #e09f3e; background: rgba(0,0,0,0.7); transform: translateY(-3px); }
        .grid-card-img-placeholder { width: 100%; height: 70px; background: rgba(255,255,255,0.05); border-radius: 6px; margin-bottom: 8px; display: flex; align-items: center; justify-content: center; font-size: 24px; color: rgba(255,255,255,0.2); }
        .grid-card-img { width: 100%; aspect-ratio: 1 / 1; object-fit: cover; object-position: center top; border-radius: 6px; margin-bottom: 8px; border: 1px solid rgba(255,255,255,0.2); box-shadow: 0 2px 5px rgba(0,0,0,0.5); }
        .grid-card-title { font-size: 13px; font-weight: bold; color: #fff; line-height: 1.2; flex-grow: 1; display: flex; align-items: center; justify-content: center; margin-bottom: 8px; text-align: center;}
        
        .card-prog-wrap { width: 100%; height: 16px; background: rgba(0,0,0,0.8); border-radius: 4px; border: 1px solid rgba(255,255,255,0.2); position: relative; overflow: hidden; }
        .card-prog-fill { height: 100%; background: #e09f3e; width: 0%; transition: width 0.3s; }
        .card-prog-txt { position: absolute; top: 0; left: 0; width: 100%; text-align: center; font-size: 11px; line-height: 16px; color: #fff; font-weight: bold; text-shadow: 1px 1px 1px #000; }
        .card-complete-txt { color: #4CAF50; font-weight: bold; font-size: 14px; margin-top: auto; text-align: center;}
        
        .grid-fast-fill { position: absolute; top: -8px; right: -8px; width: 24px; height: 24px; border-radius: 50%; background: rgba(0,0,0,0.8); border: 1px solid rgba(255,255,255,0.3); display: flex; align-items: center; justify-content: center; font-size: 12px; cursor: pointer; transition: all 0.2s; z-index: 5; }
        .grid-fast-fill.checked { background: #28a745; border-color: #28a745; color: white; }
        .grid-fast-fill.unchecked { color: transparent; }
        .grid-fast-fill.unchecked:hover { color: white; border-color: white; }
        
        .search-item { background: rgba(23, 162, 184, 0.2); border-left: 4px solid #17a2b8; text-align: left; padding: 15px; display: block; }
        .search-item span { display: block; font-size: 13px; color: #aaa; font-weight: normal; margin-top: 5px; }

        .progress-bg { width: 100%; height: 16px; background: rgba(0,0,0,0.6); border-radius: 8px; overflow: hidden; border: 1px solid rgba(255,255,255,0.1); position: relative;}
        .progress-bar { height: 100%; background: linear-gradient(90deg, #28a745, #34ce57); width: 0%; transition: width 0.4s ease; }
        .progress-text { font-size: 14px; color: #ddd; text-align: right; margin-top: 5px; font-weight: bold;}

        #top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.1);}
        #lang-selector { width: auto; padding: 8px; margin: 0; font-size: 14px; background: rgba(255,255,255,0.9); color: #000; border-radius: 5px;}
        #search-bar { position: sticky; top: 0; background: rgba(25, 35, 50, 0.95); padding: 10px 0; z-index: 10; border-radius: 10px; margin-bottom: 15px; backdrop-filter: blur(5px);}
        
        /* PUZZLE DIZ√ÅJN */
        .puzzle-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 15px; }
        .puzzle-piece { border-radius: 10px; padding: 6px; background: rgba(0,0,0,0.5); display: flex; flex-direction: column; align-items: center; box-shadow: 0 4px 6px rgba(0,0,0,0.3); transition: transform 0.1s; border: 2px solid transparent; }
        .puzzle-piece:focus { border-color: #ffc107; transform: scale(1.05); outline: none; }
        
        .piece-img-bg { width: 100%; aspect-ratio: 1 / 1; background-size: 300% 500%; background-repeat: no-repeat; border-radius: 6px; background-color: rgba(255,255,255,0.05); transition: all 0.3s; }
        .piece-missing .piece-img-bg { filter: grayscale(100%) opacity(0.3); }
        .piece-surplus { border-color: #e09f3e; }
        
        .qty-badge { position: absolute; bottom: 5px; right: 5px; background: rgba(0,0,0,0.8); color: #fff; font-size: 14px; font-weight: bold; padding: 2px 8px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.3); z-index: 2; }
        
        .controls { display: flex; align-items: center; justify-content: space-between; width: 100%; margin-top: 8px; gap: 5px; }
        .qty-btn { background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; padding: 5px 0; cursor: pointer; font-weight: bold; font-size: 18px; color: white; transition: background 0.2s; flex: 1; display: flex; align-items: center; justify-content: center; height: 32px;}
        .qty-btn:hover { background: rgba(255,255,255,0.3); }
        
        #toast-msg { visibility: hidden; min-width: 250px; background-color: rgba(40, 167, 69, 0.95); color: #fff; text-align: center; border-radius: 8px; padding: 15px; position: fixed; z-index: 1000; left: 50%; top: 50%; transform: translate(-50%, -50%); font-size: 18px; font-weight: bold; box-shadow: 0 4px 15px rgba(0,0,0,0.5); opacity: 0; transition: opacity 0.3s, visibility 0.3s; pointer-events: none; backdrop-filter: blur(5px); }
        #toast-msg.show { visibility: visible; opacity: 1; }
        
        .match-card { background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); color: white; padding: 15px; border-radius: 10px; margin: 15px auto; width: 90%; text-align: left; box-shadow: 0 4px 6px rgba(0,0,0,0.2);}
        .match-card h4 { margin: 0 0 10px 0; color: #e09f3e; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 8px; font-size: 20px;}
        .match-detail { margin: 8px 0; font-size: 14px; background: rgba(0,0,0,0.4); padding: 10px; border-radius: 8px;}
        .trade-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; border-bottom: 1px dashed rgba(255,255,255,0.1); padding-bottom: 8px;}
        
        hr { border: 0; border-top: 1px solid rgba(255,255,255,0.1); margin: 25px 0;}
        .trade-badge { position: absolute; top: -8px; right: -8px; background: #dc3545; color: white; border-radius: 50%; padding: 4px 8px; font-size: 12px; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.5); display: none; z-index: 5; }

        /* GYORS MEN√ú (CAROUSEL) ALULRA */
        .quick-nav-container { display: flex; overflow-x: auto; gap: 10px; padding: 10px 0; margin-top: 30px; border-top: 1px solid rgba(255,255,255,0.1); scroll-behavior: smooth; }
        .quick-nav-container::-webkit-scrollbar { display: none; } 
        .quick-nav-item { flex: 0 0 auto; width: 80px; text-align: center; cursor: pointer; opacity: 0.5; transition: all 0.2s; }
        .quick-nav-item.active { opacity: 1; transform: scale(1.05); border-bottom: 2px solid #e09f3e; padding-bottom: 5px; }
        .quick-nav-img { width: 100%; height: 50px; object-fit: contain; border-radius: 6px; border: 1px solid rgba(255,255,255,0.2); background: rgba(0,0,0,0.5); padding: 2px; box-sizing: border-box; }
        .quick-nav-title { font-size: 10px; color: #fff; margin-top: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

/* VIDE√ì LEJ√ÅTSZ√ì */
        .video-modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.9); align-items: center; justify-content: center; flex-direction: column; backdrop-filter: blur(5px); }
        .video-modal.show { display: flex; }
        .video-modal-content { max-width: 90%; max-height: 80%; border-radius: 10px; border: 2px solid #e09f3e; box-shadow: 0 0 20px rgba(224, 159, 62, 0.5); outline: none; }
        .close-video { position: absolute; top: 20px; right: 30px; color: white; font-size: 40px; font-weight: bold; cursor: pointer; transition: color 0.2s; }
        .close-video:hover { color: #e09f3e; }
        .btn-play { background: linear-gradient(90deg, #ff8a00, #e52e71); border: none; font-size: 12px; padding: 5px; margin-top: 5px; width: 100%; box-shadow: 0 2px 5px rgba(0,0,0,0.5); }
/* K√ÅRTYA V√ÅLT√ì NYILAK √âS EXTRA BADGE */
        .puzzle-nav-btn { position: fixed; top: 50%; transform: translateY(-50%); background: rgba(0, 0, 0, 0.7); color: white; border: 2px solid rgba(255,255,255,0.2); border-radius: 50%; width: 45px; height: 45px; display: flex; align-items: center; justify-content: center; font-size: 24px; cursor: pointer; z-index: 1000; transition: all 0.2s; box-shadow: 0 4px 10px rgba(0,0,0,0.5); backdrop-filter: blur(5px); }
        .puzzle-nav-btn:hover { background: #e09f3e; border-color: #e09f3e; transform: translateY(-50%) scale(1.1); }
        .puzzle-nav-prev { left: 10px; }
        .puzzle-nav-next { right: 10px; }
        /* Ha nagy k√©perny≈ën (PC) vagy, a nyilak a doboz sz√©l√©hez igazodnak, nem a monitor sz√©l√©hez: */
        @media (min-width: 850px) { .puzzle-nav-prev { left: calc(50% - 430px); } .puzzle-nav-next { right: calc(50% - 430px); } }
        /* MOBILOS OPTIMALIZ√ÅL√ÅS (Reszponz√≠v n√©zet) */
        @media (max-width: 600px) {
            /* 1. Az albumok k√©pei ne legyenek olyan hatalmasak mobilon */
            .album-img-large { height: 160px; }
            
            /* 2. A k√°rty√°k 3 helyett csak 2 oszlopban jelenjenek meg, hogy ne nyomorodjanak √∂ssze */
            .card-grid-container { grid-template-columns: repeat(2, 1fr); gap: 8px; }
            
            /* 3. A k√°rty√°k k√©pei t√∂k√©letes n√©gyzetek maradjanak */
            .grid-card-item { min-height: 120px; padding: 8px; }
            .grid-card-img { height: auto; aspect-ratio: 1 / 1; margin-bottom: 5px; }
            .grid-card-title { font-size: 11px; }
            
            /* 4. A puzzle darabok bogy√≥i (sz√°mok) picit kisebbek legyenek, hogy ne l√≥gjanak le a k√©pr≈ël */
            .qty-badge { font-size: 12px; padding: 1px 6px; bottom: 3px; right: 3px; }
            
            /* 5. A lapoz√≥ nyilak m√©ret√©nek finom√≠t√°sa */
            .puzzle-nav-btn { width: 35px; height: 35px; font-size: 18px; }
            .puzzle-nav-prev { left: 2px; }
            .puzzle-nav-next { right: 2px; }
        }
/* üåå Glob√°lis keres√©s elrejt√©se √©s a gombok kit√∂lt√©se */
        .t-btn-global { 
            display: none !important; 
        }
        .t-btn-clan, .t-btn-state { 
            width: calc(50% - 6px) !important; /* 50-50% egy kis r√©ssel a kett≈ë k√∂z√∂tt */
            display: inline-block;
        }

        /* Mobilon viszont t√∂lts√©k ki a teljes sz√©less√©get egym√°s alatt, hogy k√∂nnyebb legyen r√°nyomni */
        @media (max-width: 600px) {
            .t-btn-clan, .t-btn-state { width: 100% !important; margin-bottom: 8px; }
        }

    </style>
</head>
<body>

    <div id="toast-msg">‚úÖ Saved!</div>

<div id="auth-screen" class="container">
    <div style="margin-bottom: 30px;">
        <h1 style="color: #e09f3e; font-size: 32px; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 2px;">Whiteout Survival</h1>
        <h2 style="color: #fff; margin-top: 0; font-weight: normal; font-size: 22px;">‚ùÑÔ∏è Tundra Trade ‚ùÑÔ∏è</h2>
        <p style="color: #aaa; font-style: italic;">The Ultimate Puzzle Exchange Tool</p>
    </div>

    <input type="email" id="email-input" placeholder="Email address">
    <div style="position: relative; width: 90%; margin: 10px auto;">
        <input type="password" id="password-input" placeholder="Password" style="width: 100%; margin: 0; padding-right: 40px;">
        <span id="toggle-password" style="position: absolute; right: 15px; top: 50%; transform: translateY(-50%); cursor: pointer; font-size: 20px;">üëÅÔ∏è</span>
    </div>
    <div style="text-align: right; width: 90%; margin: -5px auto 15px auto;">
        <a href="#" id="forgot-password-link" style="color: #e09f3e; font-size: 14px; text-decoration: none; font-weight: bold;">Forgot password?</a>
    </div>
    <div id="auth-error" style="color:#ff6b6b; margin-bottom:10px; font-weight:bold;"></div>
    
    <button id="email-login-btn" class="btn btn-green">Login with Email</button>
    <button id="email-register-btn" class="btn btn-dark">Register new account</button>
    
    <div style="margin: 20px 0; color: #888; display: flex; align-items: center; justify-content: center;">
        <hr style="flex-grow: 1; margin: 0 15px;"><span style="font-size: 14px;">OR</span><hr style="flex-grow: 1; margin: 0 15px;">
    </div>
    <button id="google-login-btn" class="btn btn-blue">Login with Google</button>
</div> <div id="register-screen" class="container" style="display: none;">
    <h2 style="color: #e09f3e;">Create New Account</h2>
    <input type="email" id="reg-email" placeholder="Email address">
    <input type="password" id="reg-password" placeholder="Password (min. 6 chars)">
    <hr style="border-top: 1px solid rgba(255,255,255,0.1); margin: 15px 0;">
    <input type="text" id="reg-player-name" placeholder="Player Name (any characters)">
    <input type="number" id="reg-server-number" placeholder="State/Server (e.g., 253)">
    <input type="text" id="reg-alliance-name" placeholder="Alliance Tag (exactly 3 chars, e.g., ABC)">
    <div id="reg-error" style="color:#ff6b6b; margin-bottom:10px; font-weight:bold;"></div>
    <button id="do-register-btn" class="btn btn-green">Register & Play</button>
    <button id="back-to-login-btn" class="btn btn-back" style="width: 90%; margin-top: 10px;">‚¨Ö Back to Login</button>
</div>

    <div id="profile-setup-screen" class="container" style="display: none;">
        <h2 style="color: #e09f3e;">Setup your profile</h2>
        <input type="text" id="player-name" placeholder="Player Name (any characters)">
        <input type="number" id="server-number" placeholder="State/Server (3 or 4 digits, e.g., 253)">
        <input type="text" id="alliance-name" placeholder="Alliance Tag (exactly 3 chars, e.g., ABC)">
        <div id="profile-error" style="color:#ff6b6b; margin-bottom:10px; font-weight:bold;"></div>
        <button id="save-profile-btn" class="btn btn-green">Save & Continue</button>
    </div>

    <div id="main-app-screen" class="container" style="display: none;">
<div id="top-bar">
            <div style="text-align: left;">
                <h3 style="margin: 0; color:#e09f3e;" id="display-name"></h3>
                <small style="color: #ccc; display: block; margin-bottom: 8px;"><span class="t-state">State</span>: <b id="display-server" style="color:#fff;"></b> | <span class="t-alliance">Alliance</span>: <b id="display-alliance" style="color:#fff;"></b></small>
                <button id="logout-btn" class="btn btn-back t-btn-logout" style="margin: 0; padding: 4px 10px; font-size: 12px;">Logout</button>
            </div>
            <div>
                <select id="lang-selector">
                    <option value="en" selected>üá¨üáß English</option>
                    <option value="hu">üá≠üá∫ Magyar</option>
                    <option value="de">üá©üá™ Deutsch</option>
                    <option value="fr">üá´üá∑ Fran√ßais</option>
                    <option value="tr">üáπüá∑ T√ºrk√ße</option>
                    <option value="ru">üá∑üá∫ –†—É—Å—Å–∫–∏–π</option>
                    <option value="ar">üá∏üá¶ ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
                </select>
            </div>
        </div>
        
        <div class="action-buttons" style="display: flex; justify-content: space-between; gap: 5px;">
            <button id="btn-match-clan" class="btn btn-blue t-btn-clan" style="flex: 2; font-size: 13px; padding: 10px 5px; box-shadow: 0 4px 15px rgba(66, 133, 244, 0.4); position: relative;">ü§ù Search in Alliance<span id="badge-clan" class="trade-badge">0</span></button>
            <button id="btn-match-state" class="btn btn-dark t-btn-state" style="flex: 2; font-size: 13px; padding: 10px 5px; position: relative;">üåç Search in State<span id="badge-state" class="trade-badge">0</span></button>
            <button id="btn-match-global" class="btn btn-dark t-btn-global" style="flex: 1; font-size: 11px; padding: 10px 2px; position: relative; box-shadow: 0 4px 15px rgba(255, 255, 255, 0.1); line-height: 1.2; word-wrap: break-word; white-space: normal;">üåå Search in All States<span id="badge-global" class="trade-badge">0</span></button>
        </div>

        <div id="search-bar">
            <input type="text" id="search-input" class="t-search-ph" placeholder="üîç Search album or card...">
        </div>

        <div id="view-albums"></div>
        <div id="view-cards" style="display: none;"></div>
        <div id="view-puzzle" style="display: none;"></div>
        <div id="view-search-results" style="display: none;"></div>
<div id="view-matchmaker" style="display: none;"></div>
<div id="video-modal" class="video-modal">
        <span class="close-video" id="close-video-btn">&times;</span>
        <video id="card-video-player" class="video-modal-content" controls autoplay loop>
            <source src="" type="video/mp4">
            B√∂ng√©sz≈ëd nem t√°mogatja a vide√≥lej√°tsz√°st.
        </video>
    </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, query, where, getDocs, increment } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

        // IDE M√ÅSOLD BE A SAJ√ÅT KULCSODAT!
const firebaseConfig = {
  apiKey: "AIzaSyDeEK5nOuvuELtGd61Q7W04uKGcJqG1L1U",
  authDomain: "tundra-album.firebaseapp.com",
  projectId: "tundra-album",
  storageBucket: "tundra-album.firebasestorage.app",
  messagingSenderId: "469371801375",
  appId: "1:469371801375:web:71007b232a98fe8bdbea2a",
  measurementId: "G-2LQT9X23X5"
};

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        window.currentUserUid = null;
        window.userInventory = {}; 
        window.currentAlbumGlobal = null;
        window.currentCardGlobal = null;

const i18n = {
            en: { state: "State", alliance: "Alliance", btnClan: "ü§ù Search in Alliance", btnState: "üåç Search in State", btnGlobal: "üåå Search in All States", searchPh: "üîç Search album or card...", btnSave: "üíæ Save Changes", btnLogout: "Logout", backAlbum: "‚¨Ö Back to Albums", backCard: "‚¨Ö Back to Cards", markDone: "‚úî Set missing to 1", cardsOwnedInfo: "Completed Cards", givesYou: "They can give you:", asksFrom: "They ask from you:", traded: "Traded!", noMatch: "No matching players found.", tradeWarning: "‚ö†Ô∏è Only click 'Traded!' if the exchange actually happened in the game!", videoSearch: "‚è≥ Searching...", videoPending: "Video upload in progress..." },
            de: { state: "Staat", alliance: "Allianz", btnClan: "ü§ù Suche in Allianz", btnState: "üåç Suche im Staat", btnGlobal: "üåå Suche in Allen Staaten", searchPh: "üîç Album suchen...", btnSave: "üíæ Speichern", btnLogout: "Abmelden", backAlbum: "‚¨Ö Zur√ºck", backCard: "‚¨Ö Zur√ºck", markDone: "‚úî Fehlende auf 1", cardsOwnedInfo: "Komplette Karten", givesYou: "Kann dir geben:", asksFrom: "Fragt von dir:", traded: "Gehandelt!", noMatch: "Keine passenden Spieler gefunden.", tradeWarning: "‚ö†Ô∏è Klicke nur auf 'Traded!', wenn der Tausch im Spiel stattfand!", videoSearch: "‚è≥ Suchen...", videoPending: "Video-Upload l√§uft..." },
            fr: { state: "√âtat", alliance: "Alliance", btnClan: "ü§ù Chercher dans l'Alliance", btnState: "üåç Chercher dans l'√âtat", btnGlobal: "üåå Chercher dans Tous les √âtats", searchPh: "üîç Chercher...", btnSave: "üíæ Sauvegarder", btnLogout: "D√©connexion", backAlbum: "‚¨Ö Retour", backCard: "‚¨Ö Retour", markDone: "‚úî Marquer √† 1", cardsOwnedInfo: "Cartes compl√®tes", givesYou: "Peut vous donner:", asksFrom: "Vous demande:", traded: "√âchang√©!", noMatch: "Aucun joueur correspondant.", tradeWarning: "‚ö†Ô∏è Ne cliquez sur '√âchang√©' que si l'√©change a eu lieu dans le jeu !", videoSearch: "‚è≥ Recherche...", videoPending: "T√©l√©chargement de la vid√©o en cours..." },
            tr: { state: "Eyalet", alliance: "ƒ∞ttifak", btnClan: "ü§ù ƒ∞ttifakta Ara", btnState: "üåç Eyalette Ara", btnGlobal: "üåå T√ºm Eyaletlerde Ara", searchPh: "üîç Ara...", btnSave: "üíæ Kaydet", btnLogout: "√áƒ±kƒ±≈ü Yap", backAlbum: "‚¨Ö Alb√ºmlere D√∂n", backCard: "‚¨Ö Kartlara D√∂n", markDone: "‚úî Eksikleri 1 yap", cardsOwnedInfo: "Tamamlanan kartlar", givesYou: "Sana verebilir:", asksFrom: "Senden istiyor:", traded: "Takas edildi!", noMatch: "E≈üle≈üen oyuncu bulunamadƒ±.", tradeWarning: "‚ö†Ô∏è Yalnƒ±zca oyun i√ßinde takas ger√ßekle≈ütiyse 'Takas edildi!' butonuna tƒ±klayƒ±n!", videoSearch: "‚è≥ Aranƒ±yor...", videoPending: "Video y√ºklemesi devam ediyor..." },
            hu: { state: "√Ållam", alliance: "Sz√∂vets√©g", btnClan: "ü§ù Keres√©s Sz√∂vets√©gben", btnState: "üåç Keres√©s √Ållamban", btnGlobal: "üåå Keres√©s Minden √Ållamban", searchPh: "üîç Keres√©s albumra vagy k√°rty√°ra...", btnSave: "üíæ V√°ltoz√°sok Ment√©se", btnLogout: "Kijelentkez√©s", backAlbum: "‚¨Ö Vissza az Albumokhoz", backCard: "‚¨Ö Vissza a K√°rty√°khoz", markDone: "‚úî Hi√°nyz√≥k 1-re √°ll√≠t√°sa", cardsOwnedInfo: "Ezek a k√°rty√°k megvannak", givesYou: "Tud adni neked:", asksFrom: "K√©ri t≈ëled:", traded: "Elcser√©lt√ºk!", noMatch: "Nincs tal√°lat a cserepartnerekre.", tradeWarning: "‚ö†Ô∏è Csak akkor kattints a 'Traded!' gombra, ha a j√°t√©kban is megt√∂rt√©nt a csere!", videoSearch: "‚è≥ Keres√©s...", videoPending: "A vide√≥ felt√∂lt√©se folyamatban..." },
	    ru: { state: "–®—Ç–∞—Ç", alliance: "–ê–ª—å—è–Ω—Å", btnClan: "ü§ù –ü–æ–∏—Å–∫ –≤ –∞–ª—å—è–Ω—Å–µ", btnState: "üåç –ü–æ–∏—Å–∫ –≤ —à—Ç–∞—Ç–µ", btnGlobal: "üåå –ü–æ–∏—Å–∫ –≤–æ –≤—Å–µ—Ö —à—Ç–∞—Ç–∞—Ö", searchPh: "üîç –ü–æ–∏—Å–∫...", btnSave: "üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å", btnLogout: "–í—ã–π—Ç–∏", backAlbum: "‚¨Ö –ù–∞–∑–∞–¥", backCard: "‚¨Ö –ù–∞–∑–∞–¥", markDone: "‚úî –ù–∞ 1", cardsOwnedInfo: "–°–æ–±—Ä–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç—ã", givesYou: "–ú–æ–∂–µ—Ç –¥–∞—Ç—å –≤–∞–º:", asksFrom: "–ü—Ä–æ—Å–∏—Ç —É –≤–∞—Å:", traded: "–û–±–º–µ–Ω—è–ª–∏—Å—å!", noMatch: "–ò–≥—Ä–æ–∫–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.", tradeWarning: "‚ö†Ô∏è –ù–∞–∂–∏–º–∞–π—Ç–µ '–û–±–º–µ–Ω—è–ª–∏—Å—å!' —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–±–º–µ–Ω —É–∂–µ –ø—Ä–æ–∏–∑–æ—à–µ–ª –≤ –∏–≥—Ä–µ!", videoSearch: "‚è≥ –ü–æ–∏—Å–∫...", videoPending: "–ò–¥–µ—Ç –∑–∞–≥—Ä—É–∑–∫–∞ –≤–∏–¥–µ–æ..." },
            ar: { state: "ÿ≠ÿßŸÑÿ©", alliance: "ÿ™ÿ≠ÿßŸÑŸÅ", btnClan: "ü§ù ÿßŸÑÿ®ÿ≠ÿ´ ŸÅŸä ÿßŸÑÿ™ÿ≠ÿßŸÑŸÅ", btnState: "üåç ÿßŸÑÿ®ÿ≠ÿ´ ŸÅŸä ÿßŸÑŸàŸÑÿßŸäÿ©", btnGlobal: "üåå ÿßŸÑÿ®ÿ≠ÿ´ ŸÅŸä ŸÉŸÑ ÿßŸÑŸàŸÑÿßŸäÿßÿ™", searchPh: "üîç ÿßŸÑÿ®ÿ≠ÿ´...", btnSave: "üíæ ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿ∫ŸäŸäÿ±ÿßÿ™", btnLogout: "ÿ™ÿ≥ÿ¨ŸäŸÑ ÿÆÿ±Ÿàÿ¨", backAlbum: "‚¨Ö ÿßŸÑÿπŸàÿØÿ©", backCard: "‚¨Ö ÿßŸÑÿπŸàÿØÿ©", markDone: "‚úî ÿ™ÿπŸäŸäŸÜ ÿ•ŸÑŸâ 1", cardsOwnedInfo: "ÿ®ÿ∑ÿßŸÇÿßÿ™ ŸÖŸÉÿ™ŸÖŸÑÿ©", givesYou: "ŸäŸÖŸÉŸÜ ÿ£ŸÜ Ÿäÿπÿ∑ŸäŸÉ:", asksFrom: "Ÿäÿ∑ŸÑÿ® ŸÖŸÜŸÉ:", traded: "ÿ™ŸÖ ÿßŸÑÿ™ÿ®ÿßÿØŸÑ!", noMatch: "ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ŸÑÿßÿπÿ®ŸäŸÜ.", tradeWarning: "‚ö†Ô∏è ÿßŸÜŸÇÿ± ŸÅŸÇÿ∑ ÿπŸÑŸâ 'ÿ™ŸÖ ÿßŸÑÿ™ÿ®ÿßÿØŸÑ!' ÿ•ÿ∞ÿß ÿ≠ÿØÿ´ ÿßŸÑÿ™ÿ®ÿßÿØŸÑ ÿ®ÿßŸÑŸÅÿπŸÑ ŸÅŸä ÿßŸÑŸÑÿπÿ®ÿ©!", videoSearch: "‚è≥ ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ®ÿ≠ÿ´...", videoPending: "ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÅŸäÿØŸäŸà..." }
        };
        window.currLang = 'en';

        // --- AZ ALBUMOK √âS K√âPEK ---
        const albumAdatok = [
            { id: "album_0", kepFajlNev: "Rekindled_Flames.jpg", en: "Rekindled Flames", de: "Wiederentfachte Flammen", hu: "√öjra√©led≈ë L√°ngok", fr: "Flammes raviv√©es", tr: "Yeniden Alevlenen", ru: "–í–Ω–æ–≤—å –∑–∞–∂–∂–µ–Ω–Ω–æ–µ", ar: "ŸÜŸäÿ±ÿßŸÜ ŸÖÿ¥ÿ™ÿπŸÑÿ©",
              kartyaNevek: ["Furnace", "City Founding", "Dawn Alliance", "Decisions", "Menace Afoot", "Heroes", "Food Power", "A New Order", "True Explorer"],
darabszamok: [9, 9, 9, 12, 12, 12, 15, 15, 15] 
            },
            { id: "album_1", kepFajlNev: "Explore_the_World.jpg", en: "Explore the World", de: "Erkunde die Welt", hu: "Fedezd fel a Vil√°got", fr: "Explorer le monde", tr: "D√ºnyayƒ± Ke≈üfet", ru: "–ò—Å—Å–ª–µ–¥—É–π –º–∏—Ä", ar: "ÿßÿ≥ÿ™ŸÉÿ¥ŸÅ ÿßŸÑÿπÿßŸÑŸÖ",
              kartyaNevek: ["War on Winter", "Exploration Journal", "Hunting Guild", "The Raging Bear", "Treasure Kingdom", "Wealth Is Knowledge", "Ruins of Old", "Cryptid Days", "Call of the Stars"],
darabszamok: [9, 12, 12, 12, 15, 15, 15, 18, 18] 
            },
            { id: "album_2", kepFajlNev: "Daybreak_Island.jpg", en: "Daybreak Island", de: "Insel des Tagesanbruchs", hu: "Hajnal Sziget", fr: "√éle de l'Aube", tr: "≈ûafak Adasƒ±", ru: "–û—Å—Ç—Ä–æ–≤ –†–∞—Å—Å–≤–µ—Ç–∞", ar: "ÿ¨ÿ≤Ÿäÿ±ÿ© ÿßŸÑŸÅÿ¨ÿ±",
              kartyaNevek: ["Daybreak Island Legend", "Island of Dreams", "Tree of Life", "Call of the Sea", "Distant Resonance", "Caravan Visit", "New Home", "Daybreak Song", "Island Splendors"],
              darabszamok: [12, 12, 12, 15, 15, 15, 18, 18, 18] 
            },
            { id: "album_3", kepFajlNev: "Tundra_Alliance.jpg", en: "Tundra Alliance", de: "Tundra-Allianz", hu: "Tundra Sz√∂vets√©g", fr: "Alliance de la Toundra", tr: "Tundra ƒ∞ttifakƒ±", ru: "–ê–ª—å—è–Ω—Å –¢—É–Ω–¥—Ä—ã", ar: "ÿ™ÿ≠ÿßŸÑŸÅ ÿßŸÑÿ™ŸÜÿØÿ±ÿß",
              kartyaNevek: ["Alliance-Building", "One Heart", "Heroes' Aid", "Alliance Resources", "Twisted Obsession", "Virtues and Crimes", "Children of the \"New World\"", "Horn of Command", "Battlefield Epic"],
darabszamok: [12, 12, 15, 15, 15, 18, 18, 18, 18] 
            },
            { id: "album_4", kepFajlNev: "Battlefield_Epic.jpg", en: "Battlefield Epic", de: "Schlachtfeld-Epos", hu: "Csatat√©ri Eposz", fr: "√âpop√©e du champ de bataille", tr: "Sava≈ü Alanƒ± Destanƒ±", ru: "–≠–ø–æ—Å –ø–æ–ª—è –±–æ—è", ar: "ŸÖŸÑÿ≠ŸÖÿ© ÿ≥ÿßÿ≠ÿ© ÿßŸÑŸÖÿπÿ±ŸÉÿ©",
              kartyaNevek: ["Imperial Foundry", "King of the Battlefield", "Orichalcum", "City of Kings", "Pilot's Paradise", "Great Contest", "Canyon Clash", "Hero's Glory", "Grand Banquet"],
darabszamok: [12, 15, 15, 15, 15, 18, 18, 18, 18]
            },
            { id: "album_5", kepFajlNev: "Spectacular_Adventures.jpg", en: "Spectacular Adventures", de: "Spektakul√§re Abenteuer", hu: "K√ºl√∂nleges Kalandok", fr: "Aventures spectaculaires", tr: "Muhte≈üem Maceralar", ru: "–ó–∞—Ö–≤–∞—Ç—ã–≤–∞—é—â–∏–µ –ø—Ä–∏–∫–ª—é—á–µ–Ω–∏—è", ar: "ŸÖÿ∫ÿßŸÖÿ±ÿßÿ™ ŸÖÿ∞ŸáŸÑÿ©",
              kartyaNevek: ["Fishing Tournament", "Snowbusters", "Bandit", "Red-Haired Joe", "A \"Queen\" Arises", "The Eagles", "Bounty Hunter", "Wandering Merchant", "Tundra Adventure"],
darabszamok: [12, 15, 15, 15, 15, 18, 18, 18, 18]
            },
            { id: "album_6", kepFajlNev: "Divine_Weapons.jpg", en: "Divine Weapons", de: "G√∂ttliche Waffen", hu: "Isteni Fegyverek", fr: "Armes divines", tr: "ƒ∞lahi Silahlar", ru: "–ë–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ –æ—Ä—É–∂–∏–µ", ar: "ÿ£ÿ≥ŸÑÿ≠ÿ© ÿ•ŸÑŸáŸäÿ©",
              kartyaNevek: ["Master Blacksmith", "Legendary Divine Weapon", "Tundra Trade Route", "Merchant Escort", "Cryptid Invasion", "Steam Rhapsody", "Ice Journey", "Exotic Charm", "Essence Stones"],
darabszamok: [12, 15, 15, 15, 15, 18, 18, 18, 18]
            },
            { id: "album_7", kepFajlNev: "Song_of_Heroes.jpg", en: "Song of Heroes", de: "Heldenlied", hu: "H≈ës√∂k √âneke", fr: "Chant des H√©ros", tr: "Kahramanlarƒ±n ≈ûarkƒ±sƒ±", ru: "–ü–µ—Å–Ω—å –ì–µ—Ä–æ–µ–≤", ar: "ÿ£ÿ∫ŸÜŸäÿ© ÿßŸÑÿ£ÿ®ÿ∑ÿßŸÑ",
              kartyaNevek: ["Dauntless Heroes", "Snow Angel", "Everyday Champions", "Arcadia's Legacy", "\"I Am the Fire.\"", "Artisan Architect", "Life Vs Death", "The Icebreakers", "Epic of a New World"],
darabszamok: [9, 9, 12, 12, 12, 15, 15, 15, 18]
            },
            { id: "album_8", kepFajlNev: "The_Labyrinth.jpg", en: "The Labyrinth", de: "Das Labyrinth", hu: "A Labirintus", fr: "Le Labyrinthe", tr: "Labirent", ru: "–õ–∞–±–∏—Ä–∏–Ω—Ç", ar: "ÿßŸÑŸÖÿ™ÿßŸáÿ©",
              kartyaNevek: ["Underworld Mysteries", "The World Below", "Digging To Danger", "Fungal Forest", "Furnace of the Gods", "The Undergrounders", "The Project", "Gaia Heart", "The Deepest Echo"],
darabszamok: [12, 15, 15, 15, 15, 18, 18, 18, 18]
            },
            { id: "album_9", kepFajlNev: "Nature's_Strength.jpg", en: "Nature‚Äôs Strength", de: "Kraft der Natur", hu: "A Term√©szet Ereje", fr: "Force de la Nature", tr: "Doƒüanƒ±n G√ºc√º", ru: "–°–∏–ª–∞ –ø—Ä–∏—Ä–æ–¥—ã", ar: "ŸÇŸàÿ© ÿßŸÑÿ∑ÿ®Ÿäÿπÿ©",
              kartyaNevek: ["Friend of Nature", "Wild At Heart", "Beast Unleashed", "Wild Legion", "Pets-In-Arms", "Master Tamer", "Superhuman Strength", "Kasia's Struggle", "Call of the Wild"],
darabszamok: [12, 15, 15, 15, 15, 18, 18, 18, 18]
            },
            { id: "album_10", kepFajlNev: "Crystalline_Mysteries.jpg", en: "Crystalline Mysteries", de: "Kristalline Geheimnisse", hu: "Krist√°lyos Rejt√©lyek", fr: "Myst√®res Cristallins", tr: "Kristal Gizemler", ru: "–ö—Ä–∏—Å—Ç–∞–ª—å–Ω—ã–µ —Ç–∞–π–Ω—ã", ar: "ÿ£ÿ≥ÿ±ÿßÿ± ÿ®ŸÑŸàÿ±Ÿäÿ©",
              kartyaNevek: ["Fiery Crystal", "Mining the Fire", "Heirs of Empire", "Sins of Empire", "Fire Reborn", "The Burning Legion", "Promises of Fire", "Crystalline Rage", "Fire Crystal Era"],
darabszamok: [12, 15, 15, 15, 15, 18, 18, 18, 18]
            },
            { id: "album_11", kepFajlNev: "Ballad_of_Wind_and_Cold.jpg", en: "Ballad of Wind and Cold", de: "Ballade von Wind und K√§lte", hu: "A Sz√©l √©s Hideg Ballad√°ja", fr: "Ballade du Vent", tr: "R√ºzgarƒ±n Baladƒ±", ru: "–ë–∞–ª–ª–∞–¥–∞ –æ –í–µ—Ç—Ä–µ", ar: "ÿ£ÿ∫ŸÜŸäÿ© ÿßŸÑÿ±Ÿäÿ≠",
              kartyaNevek: ["Honor and Glory", "Cold Highways", "Words of the Forgotten", "Monument to the", "Alliance Showdown", "State Versus State", "The Summit of Battle", "Castle of Conflict", "Remaker of Order"],
darabszamok: [12, 15, 15, 15, 15, 18, 18, 18, 18]
            },
            { id: "album_12", kepFajlNev: "Infernal_Power.jpg", en: "Infernal Power", de: "H√∂llenmacht", hu: "Pokoli Er≈ë", fr: "Puissance Infernale", tr: "Cehennem G√ºc√º", ru: "–ê–¥—Å–∫–∞—è —Å–∏–ª–∞", ar: "ŸÇŸàÿ© ÿ¨ŸáŸÜŸÖŸäÿ©",
              kartyaNevek: ["Helios Warriors", "Crystal Strength", "Crystal Fragmentation", "Miner Madness", "Engine of the Future", "Risky Business", "Treasure of Empire", "The Communicative Heart", "The Guardians"],
darabszamok: [12, 15, 15, 15, 15, 18, 18, 18, 18]
            },
            { id: "album_13", kepFajlNev: "Prerogative_of_the_Flame.jpg", en: "Prerogative of the Flame", de: "Vorrecht der Flamme", hu: "A L√°ng El≈ëjoga", fr: "Pr√©rogative de la Flamme", tr: "Alevin Ayrƒ±calƒ±ƒüƒ±", ru: "–ü—Ä–µ—Ä–æ–≥–∞—Ç–∏–≤–∞ –ü–ª–∞–º–µ–Ω–∏", ar: "ÿßŸÖÿ™Ÿäÿßÿ≤ ÿßŸÑŸÑŸáÿ®",
              kartyaNevek: ["Whispers of the World", "Temptations of Power", "Doomsday Man", "The Hunters", "The Mad King", "The Last Empress", "The Last Collapse", "A Long Slumber", "Sky City"],
darabszamok: [12, 15, 15, 15, 15, 18, 18, 18, 18]
            },
            { id: "album_14", kepFajlNev: "Frostdragon_Empire.jpg", en: "Frostdragon Empire", de: "Frostdrachen-Imperium", hu: "Fagys√°rk√°ny Birodalom", fr: "Empire du Dragon de Givre", tr: "Buz Ejderhasƒ± ƒ∞mparatorluƒüu", ru: "–ò–º–ø–µ—Ä–∏—è –õ–µ–¥—è–Ω–æ–≥–æ –î—Ä–∞–∫–æ–Ω–∞", ar: "ÿ•ŸÖÿ®ÿ±ÿßÿ∑Ÿàÿ±Ÿäÿ© ÿ™ŸÜŸäŸÜ ÿßŸÑÿµŸÇŸäÿπ",
              kartyaNevek: ["Frostdragon Empire", "The Dragonic Legend", "Wings of Empire", "The Dragonic Legion", "Rediscovery", "Future Vision", "War and Wealth", "Banquet for a King", "A Tyrant Crowned"],
darabszamok: [12, 15, 15, 15, 15, 18, 18, 18, 18]
            },
            { id: "album_15", kepFajlNev: "Kings_of_Combat.jpg", en: "Kings of Combat", de: "K√∂nige des Kampfes", hu: "A Harc Kir√°lyai", fr: "Rois du Combat", tr: "Sava≈ü Krallarƒ±", ru: "–ö–æ—Ä–æ–ª–∏ –ë–∏—Ç–≤—ã", ar: "ŸÖŸÑŸàŸÉ ÿßŸÑŸÇÿ™ÿßŸÑ",
              kartyaNevek: ["League of Honor", "A Tournament of Heroes", "Duel of Greatness", "The Callisto", "Kings of Combat", "The Arena Gamers", "The Helios Cannon", "Behemoth", "The Bell Tolls"],
darabszamok: [12, 15, 15, 15, 15, 18, 18, 18, 18]
            }
        ];

        window.gameData = albumAdatok.map((album) => {
            const baseAlbumName = album.kepFajlNev.replace('.jpg', ''); 
            return {
                id: album.id,
                image: `images/${album.kepFajlNev}`, 
                names: { en: album.en, hu: album.hu, de: album.de, fr: album.fr, tr: album.tr, ru: album.ru, ar: album.ar },
                cards: Array.from({length: 9}, (_, cIdx) => { 
                    const cName = album.kartyaNevek ? album.kartyaNevek[cIdx] : `Card ${cIdx+1}`;
                    const safeCardName = cName.replace(/ /g, '_').replace(/['"]/g, '');
                    return {
                        id: `${album.id}_card_${cIdx+1}`, 
                        name: cName,
                        image: `images/${baseAlbumName}_${safeCardName}.jpg`, 
                        pieceCount: album.darabszamok ? album.darabszamok[cIdx] : 9
                    };
                })
            };
        });

        // --- GOMBOK √âS ESEM√âNYEK ---
		
document.getElementById('lang-selector').addEventListener('change', (e) => {
            window.currLang = e.target.value;
            const lang = window.currLang;
            
            document.querySelector('.t-state').textContent = i18n[lang].state;
            document.querySelector('.t-alliance').textContent = i18n[lang].alliance;
            document.querySelector('.t-search-ph').placeholder = i18n[lang].searchPh;
            
            if (document.querySelector('.t-btn-logout')) {
                document.querySelector('.t-btn-logout').textContent = i18n[lang].btnLogout;
            }
            
            // Kimentj√ºk a jelenlegi sz√°mokat, miel≈ëtt friss√≠tj√ºk a gombot
            const bClanVal = document.getElementById('badge-clan') ? document.getElementById('badge-clan').textContent : '0';
            const bStateVal = document.getElementById('badge-state') ? document.getElementById('badge-state').textContent : '0';
            const bGlobalVal = document.getElementById('badge-global') ? document.getElementById('badge-global').textContent : '0';

            // Visszatessz√ºk a gombok sz√∂veg√©t, √âS a kis piros badge-eket is!
            document.querySelector('.t-btn-clan').innerHTML = `${i18n[lang].btnClan}<span id="badge-clan" class="trade-badge">${bClanVal}</span>`;
            document.querySelector('.t-btn-state').innerHTML = `${i18n[lang].btnState}<span id="badge-state" class="trade-badge">${bStateVal}</span>`;
            if (document.querySelector('.t-btn-global')) {
                document.querySelector('.t-btn-global').innerHTML = `${i18n[lang].btnGlobal}<span id="badge-global" class="trade-badge">${bGlobalVal}</span>`;
            }
            
            // Friss√≠tj√ºk a piros bogy√≥k l√°that√≥s√°g√°t
            if (typeof updateTradeBadges === 'function') updateTradeBadges();
            
            if(document.getElementById('view-albums').style.display === 'block') renderAlbums();
            if(document.getElementById('view-cards').style.display === 'block') renderCards(window.currentAlbumGlobal);
            if(document.getElementById('view-puzzle').style.display === 'block') renderPuzzle(window.currentAlbumGlobal, window.currentCardGlobal);
        });

        document.getElementById('btn-match-clan').addEventListener('click', () => runMatchmaker('alliance'));
        document.getElementById('btn-match-state').addEventListener('click', () => runMatchmaker('state'));
        document.getElementById('btn-match-global').addEventListener('click', () => runMatchmaker('global'));
        document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));

        document.getElementById('search-input').addEventListener('input', (e) => {
            const queryText = e.target.value.toLowerCase().trim();
            if (queryText === '') {
                renderAlbums();
                return;
            }

            hideAllViews();
            const viewSearch = document.getElementById('view-search-results');
            viewSearch.innerHTML = `<h3 style="text-align:left;">üîç "${queryText}"</h3>`;
            let foundSomething = false;

            window.gameData.forEach(album => {
                const aName = album.names[window.currLang] || album.names['en'];
                if (aName.toLowerCase().includes(queryText)) {
                    foundSomething = true;
                    const res = document.createElement('div');
                    res.className = 'list-item search-item';
                    res.innerHTML = `üìñ ${aName}`;
                    res.onclick = () => renderCards(album);
                    viewSearch.appendChild(res);
                }
                album.cards.forEach(card => {
                    if (card.name.toLowerCase().includes(queryText)) {
                        foundSomething = true;
                        const res = document.createElement('div');
                        res.className = 'list-item search-item card-item';
                        res.innerHTML = `${card.name} <span>${aName}</span>`;
                        res.onclick = () => renderPuzzle(album, card);
                        viewSearch.appendChild(res);
                    }
                });
            });

            if (!foundSomething) { viewSearch.innerHTML += `<p>${i18n[window.currLang].noMatch}</p>`; }
            viewSearch.style.display = 'block';
        });

        // --- ENTERREL BEL√âP√âS ---
        const handleLoginEnter = (e) => {
            if (e.key === 'Enter') {
                document.getElementById('email-login-btn').click();
            }
        };
        document.getElementById('email-input').addEventListener('keydown', handleLoginEnter);
        document.getElementById('password-input').addEventListener('keydown', handleLoginEnter);

        // --- JELSZ√ì L√ÅTHAT√ìS√ÅG √âS RESET ---
        document.getElementById('toggle-password').addEventListener('click', function() {
            const pwdInput = document.getElementById('password-input');
            if (pwdInput.type === 'password') {
                pwdInput.type = 'text';
                this.textContent = 'üôà';
            } else {
                pwdInput.type = 'password';
                this.textContent = 'üëÅÔ∏è';
            }
        });

        document.getElementById('forgot-password-link').addEventListener('click', (e) => {
            e.preventDefault();
            const email = document.getElementById('email-input').value.trim();
            const errorDiv = document.getElementById('auth-error');
            if (!email) {
                errorDiv.style.color = "#ff6b6b";
                errorDiv.textContent = "Please enter your email address above first!";
                return;
            }
            sendPasswordResetEmail(auth, email).then(() => {
                errorDiv.style.color = "#28a745"; 
                errorDiv.textContent = "Password reset email sent! Check your inbox.";
            }).catch((error) => {
                errorDiv.style.color = "#ff6b6b";
                errorDiv.textContent = "Error: " + error.message;
            });
        });

const authScreen = document.getElementById('auth-screen');
        const profileScreen = document.getElementById('profile-setup-screen');
        const mainScreen = document.getElementById('main-app-screen');
        const registerScreen = document.getElementById('register-screen'); // <-- √öJ

        function showScreen(screen) {
            authScreen.style.display = 'none';
            profileScreen.style.display = 'none';
            mainScreen.style.display = 'none';
            if(registerScreen) registerScreen.style.display = 'none';
            screen.style.display = 'block';
        }

// √Åtl√©p√©s az √∫j regisztr√°ci√≥s fel√ºletre
        document.getElementById('email-register-btn').addEventListener('click', () => {
            showScreen(registerScreen);
        });

        // Visszal√©p√©s a bejelentkez√©shez
        document.getElementById('back-to-login-btn').addEventListener('click', () => {
            showScreen(authScreen);
        });

        // A t√©nyleges regisztr√°ci√≥ lebonyol√≠t√°sa mindennel egy√ºtt
        document.getElementById('do-register-btn').addEventListener('click', async () => {
            const email = document.getElementById('reg-email').value.trim();
            const password = document.getElementById('reg-password').value;
            const pName = document.getElementById('reg-player-name').value.trim();
           const pServer = document.getElementById('reg-server-number').value.trim();
            const pAlliance = document.getElementById('reg-alliance-name').value.trim().toUpperCase();
            const errorDiv = document.getElementById('reg-error');

            if (!email || !password || !pName || !pServer || pAlliance.length !== 3) {
                errorDiv.textContent = "Please fill in all fields correctly (Alliance exactly 3 chars).";
                return;
            }

            try {
                // 1. Fi√≥k l√©trehoz√°sa
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                
                // 2. Profil azonnali ment√©se az adatb√°zisba
                await setDoc(doc(db, "jatekosok", user.uid), {
                    nev: email.split('@')[0], 
                    jatekNev: pName,
                    szerver: pServer,
                    szovetseg: pAlliance,
                    inventory: {}
                });
                
                // 3. Friss√≠tj√ºk az oldalt, hogy automatikusan bel√©pjen a f≈ëk√©perny≈ëre
                window.location.reload();
            } catch (e) {
                errorDiv.textContent = e.message;
            }
        });
// --- EMAIL ALAP√ö BEJELENTKEZ√âS V√âGREHAJT√ÅSA ---
document.getElementById('email-login-btn').addEventListener('click', async () => {
    const email = document.getElementById('email-input').value.trim();
    const password = document.getElementById('password-input').value;
    const errorDiv = document.getElementById('auth-error');

    if (!email || !password) {
        errorDiv.textContent = "Please enter both email and password.";
        return;
    }

    try {
        await signInWithEmailAndPassword(auth, email, password);
        // Ha sikeres, a m√°r meg√≠rt onAuthStateChanged fogja bet√∂lteni a f≈ëk√©perny≈ët
    } catch (error) {
        errorDiv.textContent = error.message;
    }
});

// --- GOOGLE ALAP√ö BEJELENTKEZ√âS V√âGREHAJT√ÅSA ---
document.getElementById('google-login-btn').addEventListener('click', async () => {
    const errorDiv = document.getElementById('auth-error');
    try {
        await signInWithPopup(auth, provider);
        // Ha sikeres, a m√°r meg√≠rt onAuthStateChanged fogja bet√∂lteni a f≈ëk√©perny≈ët
    } catch (error) {
        errorDiv.textContent = error.message;
    }
});
async function checkUserProfile(uid) {
            const docSnap = await getDoc(doc(db, "jatekosok", uid));
            if (docSnap.exists() && docSnap.data().szerver) {
                const data = docSnap.data();
                window.userInventory = data.inventory || {}; 
                
                // --- SAJ√ÅT SZ√ÅZAL√âK KISZ√ÅMOL√ÅSA ---
                let totalPieces = 0;
                window.gameData.forEach(a => a.cards.forEach(c => totalPieces += c.pieceCount));
                let myPieces = 0;
                for (const key in window.userInventory) { if (window.userInventory[key] > 0) myPieces++; }
                let myPct = totalPieces > 0 ? Math.round((myPieces / totalPieces) * 100) : 0;
                
                // N√©v √©s sz√°zal√©k ki√≠r√°sa a fejl√©cbe
                const myName = data.jatekNev || data.nev;
                document.getElementById('display-name').innerHTML = `${myName} <span style="color:#28a745; font-size:16px; margin-left:10px; text-shadow:1px 1px 2px black;">${myPct}%</span>`;
                
                document.getElementById('display-server').textContent = data.szerver;
                document.getElementById('display-alliance').textContent = data.szovetseg;
                
                renderAlbums(); 
                showScreen(mainScreen);
                updateTradeBadges();
            } else { showScreen(profileScreen); }
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) { window.currentUserUid = user.uid; checkUserProfile(user.uid); } 
            else { window.currentUserUid = null; showScreen(authScreen); }
        });

        function hideAllViews() { 
            document.getElementById('view-albums').style.display = 'none'; 
            document.getElementById('view-cards').style.display = 'none'; 
            document.getElementById('view-puzzle').style.display = 'none'; 
            document.getElementById('view-matchmaker').style.display='none'; 
            document.getElementById('view-search-results').style.display='none'; 
        }

        function renderAlbums() {
            hideAllViews();
            window.currentAlbumGlobal = null; window.currentCardGlobal = null;
            document.getElementById('search-input').value = ''; 
            const viewAlbums = document.getElementById('view-albums');
            viewAlbums.innerHTML = '';
            
            window.gameData.forEach(album => {
                const aName = album.names[window.currLang] || album.names['en'];
                let completedCards = 0;
                album.cards.forEach(card => {
                    let isComplete = true;
                    for(let p = 1; p <= card.pieceCount; p++) {
                        const pid = `${card.id}_piece_${p}`;
                        if(!window.userInventory[pid] || window.userInventory[pid] === 0) { isComplete = false; break; }
                    }
                    if(isComplete) completedCards++;
                });
                
                const progressPct = Math.round((completedCards / album.cards.length) * 100);

                const btn = document.createElement('div');
                btn.className = 'list-item album-card';
                btn.onclick = () => renderCards(album);
                
                btn.innerHTML = `
                    <img src="${album.image}" class="album-img-large" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%22100%22%3E%3Crect width=%22100%22 height=%22100%22 fill=%22%23555%22/%3E%3Ctext x=%2250%22 y=%2255%22 font-family=%22Arial%22 font-size=%2230%22 fill=%22%23fff%22 text-anchor=%22middle%22%3E?%3C/text%3E%3C/svg%3E'">
                    <div class="album-info-box">
                        <div class="album-title-large">${aName}</div>
                        <div style="position: relative; width: 100%; height: 18px; background: rgba(0,0,0,0.6); border-radius: 10px; margin-top: 10px; overflow: hidden; border: 1px solid rgba(255,255,255,0.2); box-shadow: inset 0 1px 3px rgba(0,0,0,0.5);">
                            <div class="progress-bar" style="width: ${progressPct}%; height: 100%; background: linear-gradient(90deg, #28a745, #34ce57); transition: width 0.3s ease;"></div>
                            <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; color: white; text-shadow: 1px 1px 3px black; pointer-events: none;">
                                ${completedCards} / ${album.cards.length} ${i18n[window.currLang].cardsOwnedInfo.split(' ')[0]}
                            </div>
                        </div>
                `;
                viewAlbums.appendChild(btn);
            });
            viewAlbums.style.display = 'block';
        }

        function renderCards(album) {
            hideAllViews();
            window.currentAlbumGlobal = album;
            const viewCards = document.getElementById('view-cards');
            viewCards.innerHTML = '';
            const aName = album.names[window.currLang] || album.names['en'];

            const topDiv = document.createElement('div');
            topDiv.style.display = "flex"; 
            topDiv.style.justifyContent = "flex-start"; 
            topDiv.style.marginBottom = "15px";

            const backBtn = document.createElement('button');
            backBtn.className = 'btn btn-back';
            backBtn.style.margin = "0"; 
            backBtn.textContent = i18n[window.currLang].backAlbum;
            backBtn.onclick = () => renderAlbums();
            
            topDiv.appendChild(backBtn);
            viewCards.appendChild(topDiv);

            viewCards.insertAdjacentHTML('beforeend', `
                <h3 style="text-align:left; margin-top:0;">üìñ ${aName}</h3>
                <p style="text-align:right; font-size:12px; color:#aaa; margin-bottom:5px;">${i18n[window.currLang].cardsOwnedInfo} ‚¨á</p>
            `);
            
            const gridContainer = document.createElement('div');
            gridContainer.className = 'card-grid-container';

            album.cards.forEach(card => {
                let collectedPieces = 0;
                for(let p = 1; p <= card.pieceCount; p++) {
                    const pid = `${card.id}_piece_${p}`;
                    if(window.userInventory[pid] && window.userInventory[pid] > 0) {
                        collectedPieces++;
                    }
                }
                const isComplete = collectedPieces === card.pieceCount;
                const progressPct = Math.round((collectedPieces / card.pieceCount) * 100);

                const cardDiv = document.createElement('div');
                cardDiv.className = 'grid-card-item';
                cardDiv.onclick = () => renderPuzzle(album, card);
                
                const fastFillBtn = document.createElement('div');
                fastFillBtn.className = `grid-fast-fill ${isComplete ? 'checked' : 'unchecked'}`;
                fastFillBtn.innerHTML = '‚úî';
                fastFillBtn.onclick = (e) => {
                    e.stopPropagation(); 
                    if(isComplete) {
                        for(let p = 1; p <= card.pieceCount; p++) {
                            const pid = `${card.id}_piece_${p}`;
                            window.userInventory[pid] = 0;
                        }
                    } else {
                        for(let p = 1; p <= card.pieceCount; p++) {
                            const pid = `${card.id}_piece_${p}`;
                            if(!window.userInventory[pid] || window.userInventory[pid] === 0) window.userInventory[pid] = 1;
                        }
                    }
                    renderCards(album); 
                    triggerAutoSave(); 
                };
                
let statusHtml = '';
                if (isComplete) {
                    const videoUrl = card.image.replace('.jpg', '.mp4');
                    const vidContainerId = `vid-status-${card.id}`;
                    
                    statusHtml = `
                        <div class="card-complete-txt">Complete</div>
                        <div id="${vidContainerId}" style="margin-top: 5px; font-size: 10px; color: #ffc107; text-align: center; font-style: italic; line-height: 1.2;">${i18n[window.currLang].videoSearch}</div>
                    `;
                    
                    fetch(videoUrl, { method: 'HEAD' })
                        .then(response => {
                            const container = document.getElementById(vidContainerId);
                            if (!container) return;
                            
                            if (response.ok) {
                                container.innerHTML = `<button class="btn btn-play btn-small" style="margin:0; width:100%;" onclick="event.stopPropagation(); playCardVideo('${videoUrl}')">‚ñ∂Ô∏è Play Animation</button>`;
                            } else {
                                container.innerHTML = i18n[window.currLang].videoPending;
                            }
                        })
                        .catch(() => {
                            const container = document.getElementById(vidContainerId);
                            if (container) container.innerHTML = i18n[window.currLang].videoPending;
                        });
                        
                } else {
                    statusHtml = `
                        <div class="card-prog-wrap">
                            <div class="card-prog-fill" style="width: ${progressPct}%"></div>
                            <div class="card-prog-txt">${collectedPieces}/${card.pieceCount}</div>
                        </div>
                    `;
                }

                cardDiv.innerHTML = `
                    <img src="${card.image}" class="grid-card-img" onerror="this.outerHTML='<div class=\\'grid-card-img-placeholder\\'>üñºÔ∏è</div>'">
                    <div class="grid-card-title">${card.name}</div>
                    ${statusHtml}
                `;
                
                cardDiv.appendChild(fastFillBtn);
                gridContainer.appendChild(cardDiv);
            });
            
            viewCards.appendChild(gridContainer);
            viewCards.style.display = 'block';
        }

        function renderPuzzle(album, card) {
            hideAllViews();
            window.currentAlbumGlobal = album; window.currentCardGlobal = card;
            const viewPuzzle = document.getElementById('view-puzzle');
            viewPuzzle.innerHTML = '';
            const aName = album.names[window.currLang] || album.names['en'];

            const topDiv = document.createElement('div');
            topDiv.style.display = "flex"; topDiv.style.justifyContent = "space-between";
            
            const backBtn = document.createElement('button');
            backBtn.className = 'btn btn-back';
            backBtn.style.margin = "0";
            backBtn.textContent = i18n[window.currLang].backCard;
            backBtn.onclick = () => renderCards(album);

            const fillBtn = document.createElement('button');
            fillBtn.className = 'btn btn-green btn-small';
            fillBtn.style.margin = "0";
            fillBtn.textContent = i18n[window.currLang].markDone;
            fillBtn.onclick = () => {
                for(let p = 1; p <= card.pieceCount; p++) {
                    const pid = `${card.id}_piece_${p}`;
                    if(!window.userInventory[pid] || window.userInventory[pid] === 0) window.userInventory[pid] = 1; 
                }
                renderPuzzle(album, card);
                triggerAutoSave();
            };

            topDiv.appendChild(backBtn);
            topDiv.appendChild(fillBtn);
            viewPuzzle.appendChild(topDiv);

            viewPuzzle.insertAdjacentHTML('beforeend', `<h3 style="text-align:left;"><small style="color:#e09f3e;">${aName}</small><br>${card.name}</h3>`);
            
            const grid = document.createElement('div');
            grid.className = 'puzzle-grid';

            const totalRows = Math.ceil(card.pieceCount / 3);

            for(let p = 1; p <= card.pieceCount; p++) {
                const pieceId = `${card.id}_piece_${p}`;
                const currentQty = window.userInventory[pieceId] || 0; 
                let bgClass = '';
                if (currentQty === 0) bgClass = 'piece-missing'; 
                else if (currentQty > 1) bgClass = 'piece-surplus';
                
                const col = (p - 1) % 3;
                const row = Math.floor((p - 1) / 3);
                const bgX = col * 50; 
                const bgY = totalRows > 1 ? row * (100 / (totalRows - 1)) : 0; 

                const pieceDiv = document.createElement('div');
                pieceDiv.className = `puzzle-piece ${bgClass}`;
                pieceDiv.id = `box-${pieceId}`;
                pieceDiv.tabIndex = 0; 
                
                pieceDiv.onkeydown = (e) => {
                    if (e.key === 'ArrowUp') { updateQty(pieceId, 1); e.preventDefault(); }
                    if (e.key === 'ArrowDown') { updateQty(pieceId, -1); e.preventDefault(); }
                    if (e.key === 'ArrowRight') { if(pieceDiv.nextElementSibling) pieceDiv.nextElementSibling.focus(); e.preventDefault(); }
                    if (e.key === 'ArrowLeft') { if(pieceDiv.previousElementSibling) pieceDiv.previousElementSibling.focus(); e.preventDefault(); }
                };
                
                const bgSizeY = totalRows * 100;

                // Bet√∂lt√©skor is ellen≈ërizz√ºk az √∫j logik√°t
                let badgeHtml = '';
                if (currentQty === 0) {
                    badgeHtml = `<div class="qty-badge" id="qty-${pieceId}">0</div>`;
                } else if (currentQty === 1) {
                    badgeHtml = `<div class="qty-badge" id="qty-${pieceId}" style="display:none;"></div>`;
                } else {
                    badgeHtml = `<div class="qty-badge" id="qty-${pieceId}" style="background:#28a745; border-color:#28a745; color:white;">+${currentQty - 1}</div>`;
                }

                pieceDiv.innerHTML = `
                    <div style="position: relative; width: 100%;">
                        <div class="piece-img-bg" style="background-image: url('${card.image}'); background-position: ${bgX}% ${bgY}%; background-size: 300% ${bgSizeY}%;"></div>
                        ${badgeHtml}
                    </div>
                    <div class="controls">
                        <button tabindex="-1" class="qty-btn minus" id="minus-${pieceId}">-</button>
                        <button tabindex="-1" class="qty-btn plus" id="plus-${pieceId}">+</button>
                    </div>
                `;
                grid.appendChild(pieceDiv);
                
                setTimeout(() => {
                    document.getElementById(`minus-${pieceId}`).addEventListener('click', () => { updateQty(pieceId, -1); });
                    document.getElementById(`plus-${pieceId}`).addEventListener('click', () => { updateQty(pieceId, 1); });
                }, 0);
            }
            viewPuzzle.appendChild(grid);

            // GYORS MEN√ú (CAROUSEL) ALULRA
            const quickNav = document.createElement('div');
            quickNav.className = 'quick-nav-container';
            
            album.cards.forEach(c => {
                const navItem = document.createElement('div');
                navItem.className = `quick-nav-item ${c.id === card.id ? 'active' : ''}`;
                navItem.onclick = () => renderPuzzle(album, c); 
                navItem.innerHTML = `
                    <img src="${c.image}" class="quick-nav-img" onerror="this.outerHTML='<div class=\\'quick-nav-img\\' style=\\'display:flex;align-items:center;justify-content:center;font-size:16px;\\'>üñºÔ∏è</div>'">
                    <div class="quick-nav-title">${c.name}</div>
                `;
                quickNav.appendChild(navItem);
            });
            viewPuzzle.appendChild(quickNav);
// --- √öJ: K√ÅRTYA V√ÅLT√ì NYILAK (BAL/JOBB) K√ñZ√âPRE ---
            const cardIndex = album.cards.findIndex(c => c.id === card.id);
            if (cardIndex > 0) {
                const prevBtn = document.createElement('div');
                prevBtn.className = 'puzzle-nav-btn puzzle-nav-prev';
                prevBtn.innerHTML = '‚ùÆ';
                prevBtn.onclick = () => renderPuzzle(album, album.cards[cardIndex - 1]);
                viewPuzzle.appendChild(prevBtn);
            }
            if (cardIndex < album.cards.length - 1) {
                const nextBtn = document.createElement('div');
                nextBtn.className = 'puzzle-nav-btn puzzle-nav-next';
                nextBtn.innerHTML = '‚ùØ';
                nextBtn.onclick = () => renderPuzzle(album, album.cards[cardIndex + 1]);
                viewPuzzle.appendChild(nextBtn);
            }
            viewPuzzle.style.display = 'block';
        }

        // --- OKOS AUTOMATIKUS MENT√âS ---
        let autoSaveTimeout;
        function triggerAutoSave() {
            clearTimeout(autoSaveTimeout);
            autoSaveTimeout = setTimeout(async () => {
                const toast = document.getElementById('toast-msg');
                try {
                    await updateDoc(doc(db, "jatekosok", window.currentUserUid), { inventory: window.userInventory });
                    toast.textContent = "‚úÖ Auto-Saved!";
                    toast.classList.add("show");
                    setTimeout(() => toast.classList.remove("show"), 2000);
                    if (typeof updateTradeBadges === 'function') updateTradeBadges();
                } catch (error) { console.error("Auto-save failed", error); }
            }, 1000); 
        }
function updateQty(pieceId, change) {
            let currentQty = window.userInventory[pieceId] || 0;
            currentQty += change;
            if (currentQty < 0) currentQty = 0; 
            window.userInventory[pieceId] = currentQty; 
            
            const pieceBox = document.getElementById(`box-${pieceId}`);
            pieceBox.classList.remove('piece-missing', 'piece-surplus');
            
            const badge = document.getElementById(`qty-${pieceId}`);
            
            // AZ √öJ LOGIKA: 0, Elt√ºntet√©s (1), vagy +Z√∂ld Felesleg (>1)
            if(currentQty === 0) { 
                pieceBox.classList.add('piece-missing'); 
                badge.textContent = '0';
                badge.style.display = 'block';
                badge.style.background = 'rgba(0,0,0,0.8)';
                badge.style.borderColor = 'rgba(255,255,255,0.3)';
            } else if(currentQty === 1) { 
                // Ha pontosan 1 van, a jelv√©ny elt≈±nik!
                badge.style.display = 'none';
            } else if(currentQty > 1) { 
                pieceBox.classList.add('piece-surplus'); 
                // Ha 2 van, akkor az +1 csere!
                badge.textContent = `+${currentQty - 1}`;
                badge.style.display = 'block';
                badge.style.background = '#28a745'; // Z√∂ld sz√≠n
                badge.style.borderColor = '#28a745';
            }

            triggerAutoSave();
        }

        async function runMatchmaker(scope) {
            hideAllViews();
            const viewMatchmaker = document.getElementById('view-matchmaker');
            viewMatchmaker.innerHTML = '<h3>‚è≥...</h3>';
            viewMatchmaker.style.display = 'block';

            const backBtn = document.createElement('button');
            backBtn.className = 'btn btn-back';
            backBtn.textContent = i18n[window.currLang].backAlbum;
            backBtn.onclick = () => renderAlbums();

            try {
                const myServer = document.getElementById('display-server').textContent;
                const myAlliance = document.getElementById('display-alliance').textContent;

                let q;
                if (scope === 'alliance') q = query(collection(db, "jatekosok"), where("szerver", "==", myServer), where("szovetseg", "==", myAlliance));
                else if (scope === 'state') q = query(collection(db, "jatekosok"), where("szerver", "==", myServer));
                else q = query(collection(db, "jatekosok"));
                
                const querySnapshot = await getDocs(q);

                let resultsHtml = '';
                let hasMatches = false;

                querySnapshot.forEach((userDoc) => {
                    if (userDoc.id === window.currentUserUid) return; 

                    const otherData = userDoc.data();
                    const otherInv = otherData.inventory || {};
                    const otherName = `[#${otherData.szerver}] [${otherData.szovetseg}] ${otherData.jatekNev || otherData.nev}`;

                    let giveToMe = []; 
                    let takeFromMe = []; 

                    window.gameData.forEach(album => {
                        const aName = album.names[window.currLang] || album.names['en'];
                        album.cards.forEach(card => {
                            for(let p = 1; p <= card.pieceCount; p++) {
                                const pieceId = `${card.id}_piece_${p}`;
                                const myQty = window.userInventory[pieceId] || 0;
                                const otherQty = otherInv[pieceId] || 0;
                                const pieceName = `<b>${aName}</b><br>${card.name} / ${p}.`;

                                if (myQty === 0 && otherQty >= 2) {
                                    giveToMe.push(`<div class="trade-row"><span>üü¢ ${pieceName}</span><button class="btn btn-green btn-small trade-action" data-uid="${userDoc.id}" data-piece="${pieceId}" data-type="receive">${i18n[window.currLang].traded}</button></div>`);
                                }
                                if (myQty >= 2 && otherQty === 0) {
                                    takeFromMe.push(`<div class="trade-row"><span>üîµ ${pieceName}</span><button class="btn btn-blue btn-small trade-action" data-uid="${userDoc.id}" data-piece="${pieceId}" data-type="give">${i18n[window.currLang].traded}</button></div>`);
                                }
                            }
                        });
                    });

// --- 1. Kisz√°moljuk az √ñSSZES L√âTEZ≈ê darabot a j√°t√©kban (pl. 500 db) ---
                    let totalPiecesInGame = 0;
                    window.gameData.forEach(a => a.cards.forEach(c => totalPiecesInGame += c.pieceCount));
                    
                    // --- 2. Megsz√°moljuk, hogy EBB≈êL mennyi van meg a m√°sik j√°t√©kosnak ---
                    let ownedUniquePieces = 0;
                    for (const key in otherInv) { 
                        if (otherInv[key] > 0) ownedUniquePieces++; 
                    }
                    
                    // --- 3. Kisz√°moljuk a %-ot: (Birtokolt darabok / √ñsszes darab) * 100 ---
                    let completionPct = totalPiecesInGame > 0 ? Math.round((ownedUniquePieces / totalPiecesInGame) * 100) : 0;
                    if (completionPct > 100) completionPct = 100;

                    let totalTrades = giveToMe.length + takeFromMe.length;
                    if (totalTrades > 0) {
                        hasMatches = true;
                        resultsHtml += `
                        <details class="match-card" style="cursor:pointer;">
                            <summary style="outline: none; font-size: 18px; font-weight: bold; color: #e09f3e; padding-bottom: 8px; border-bottom: 1px solid rgba(255,255,255,0.1);">
                                üë§ ${otherName} <span style="color:#28a745; font-size:15px; margin-left: 8px; text-shadow: 1px 1px 2px black;">${completionPct}%</span>
                                <span style="color:#fff; font-size:14px; font-weight:normal; float:right;">(${totalTrades} üîÑ)</span>
                            </summary>
                            <div style="cursor:default; margin-top: 10px;">`;
                            
                        if (giveToMe.length > 0) resultsHtml += `<div class="match-detail" style="border-left: 3px solid #28a745;"><b style="color:#28a745;">${i18n[window.currLang].givesYou}</b><br>${giveToMe.join('')}</div>`;
                        if (takeFromMe.length > 0) resultsHtml += `<div class="match-detail" style="border-left: 3px solid #4285F4;"><b style="color:#4285F4;">${i18n[window.currLang].asksFrom}</b><br>${takeFromMe.join('')}</div>`;
                        
                        resultsHtml += `</div></details>`;
                    }

                });

                viewMatchmaker.innerHTML = '';
                viewMatchmaker.appendChild(backBtn);
                viewMatchmaker.insertAdjacentHTML('beforeend', `
                    <h3>${scope === 'alliance' ? 'ü§ù ' + myAlliance : (scope === 'state' ? 'üåç ' + myServer : 'üåå All States')}</h3>
                    <p style="color: #ffc107; font-size: 13px; font-weight: bold; background: rgba(0,0,0,0.5); padding: 10px; border-radius: 8px; border: 1px solid #ffc107; margin-bottom: 20px;">
                        ${i18n[window.currLang].tradeWarning}
                    </p>
                `);

                if (hasMatches) {
                    viewMatchmaker.insertAdjacentHTML('beforeend', resultsHtml);
                    setTimeout(() => {
                        document.querySelectorAll('.trade-action').forEach(btn => {
                            btn.addEventListener('click', function() {
                                executeTrade(this.getAttribute('data-uid'), this.getAttribute('data-piece'), this.getAttribute('data-type'), this);
                            });
                        });
                    }, 0);
                }
                else viewMatchmaker.insertAdjacentHTML('beforeend', `<p>${i18n[window.currLang].noMatch}</p>`);

            } catch (error) { viewMatchmaker.innerHTML = '<h3>‚ùå Error</h3>'; viewMatchmaker.appendChild(backBtn); console.error(error); }
        }

        async function executeTrade(otherUid, pieceId, type, btnElement) {
            if(!confirm("Are you sure? This updates both inventories!")) return;
            btnElement.disabled = true;
            btnElement.textContent = "‚è≥...";

            try {
                let myChange = (type === 'give') ? -1 : 1;
                let otherChange = (type === 'give') ? 1 : -1;
                await updateDoc(doc(db, "jatekosok", window.currentUserUid), { [`inventory.${pieceId}`]: increment(myChange) });
                await updateDoc(doc(db, "jatekosok", otherUid), { [`inventory.${pieceId}`]: increment(otherChange) });
                window.userInventory[pieceId] = (window.userInventory[pieceId] || 0) + myChange;
                btnElement.textContent = "‚úÖ";
                btnElement.style.backgroundColor = "#555";
            } catch(error) { alert("Trade error!"); btnElement.disabled = false; btnElement.textContent = i18n[window.currLang].traded; }
        }

        async function updateTradeBadges() {
            try {
                const myServer = document.getElementById('display-server').textContent;
                const myAlliance = document.getElementById('display-alliance').textContent;
                
                const qGlobal = query(collection(db, "jatekosok"));
                const globalSnapshot = await getDocs(qGlobal);

                let clanTrades = 0, stateTrades = 0, globalTrades = 0;

                globalSnapshot.forEach((userDoc) => {
                    if (userDoc.id === window.currentUserUid) return;
                    const otherData = userDoc.data();
                    const otherInv = otherData.inventory || {};
                    let userTradeCount = 0;

                    for (let aIdx = 0; aIdx < window.gameData.length; aIdx++) {
                        const album = window.gameData[aIdx];
                        for (let cIdx = 0; cIdx < album.cards.length; cIdx++) {
                            const card = album.cards[cIdx];
                            for(let p = 1; p <= card.pieceCount; p++) {
                                const pieceId = `${card.id}_piece_${p}`;
                                const myQty = window.userInventory[pieceId] || 0;
                                const otherQty = otherInv[pieceId] || 0;

                                if ((myQty === 0 && otherQty >= 2) || (myQty >= 2 && otherQty === 0)) {
                                    userTradeCount++;
                                }
                            }
                        }
                    }

                    if (userTradeCount > 0) {
                        globalTrades += userTradeCount;
                        if (otherData.szerver === myServer) {
                            stateTrades += userTradeCount;
                            if (otherData.szovetseg === myAlliance) {
                                clanTrades += userTradeCount;
                            }
                        }
                    }
                });

                const bClan = document.getElementById('badge-clan');
                const bState = document.getElementById('badge-state');
                const bGlobal = document.getElementById('badge-global');

                if(clanTrades > 0) { bClan.textContent = clanTrades; bClan.style.display = 'block'; } else { bClan.style.display = 'none'; }
                if(stateTrades > 0) { bState.textContent = stateTrades; bState.style.display = 'block'; } else { bState.style.display = 'none'; }
                if(globalTrades > 0) { bGlobal.textContent = globalTrades; bGlobal.style.display = 'block'; } else { bGlobal.style.display = 'none'; }
            } catch (e) { console.error("Badge update error", e); }
        }
// --- VIDE√ì LEJ√ÅTSZ√ì LOGIKA ---
        window.playCardVideo = function(videoUrl) {
            const modal = document.getElementById('video-modal');
            const player = document.getElementById('card-video-player');
            player.src = videoUrl;
            modal.classList.add('show');
            player.play().catch(e => console.log("Auto-play prevented", e));
        };

        document.getElementById('close-video-btn').addEventListener('click', () => {
            const modal = document.getElementById('video-modal');
            const player = document.getElementById('card-video-player');
            player.pause();
            player.src = ""; // Ki√ºr√≠tj√ºk, hogy ne t√∂lts√∂n feleslegesen
            modal.classList.remove('show');
        });
    </script>
</body>

</html>




